<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HookWise - Webhook Router</title>
    <link rel="icon" type="image/png" href="{{ url_for('static', filename='img/logo.png') }}">
    <link href="{{ url_for('static', filename='css/bootstrap.min.css') }}" rel="stylesheet">
    <link href="{{ url_for('static', filename='css/prism.css') }}" rel="stylesheet">
    <link href="{{ url_for('static', filename='css/style.css') }}" rel="stylesheet">
    <meta name="csrf-token" content="{{ csrf_token() }}">
</head>

<body hx-boost="true" hx-headers='{"X-CSRF-Token": "{{ csrf_token() }}"}'>
    <div id="loading-bar" style="width: 0%;"></div>
    {% if request.endpoint != 'main.login' %}
    <nav class="navbar navbar-expand-lg navbar-dark sticky-top">
        <div class="container">
            <a class="navbar-brand d-flex align-items-center" href="{{ url_for('main.index') }}">
                <div class="hw-logo-container" id="persistent-logo" hx-preserve="true">
                    <svg class="logo-8bit-svg" viewBox="0 0 400 80" xmlns="http://www.w3.org/2000/svg">
                        <!-- Refined Spawning Word Group (Centered @ 42,16) -->
                        <g class="word-group" transform="translate(42, 16)">
                            <!-- 'H' -->
                            <path class="snap-letter" style="animation-delay: 0.1s" fill="none"
                                stroke="var(--retro-cyan)" stroke-width="8" d="M4 0 v48 M4 24 h24 M28 0 v48" />
                            <!-- 'o' -->
                            <rect class="snap-letter" style="animation-delay: 0.2s" x="44" y="16" width="32" height="32"
                                fill="none" stroke="var(--retro-white)" stroke-width="8" />
                            <!-- 'o' -->
                            <rect class="snap-letter" style="animation-delay: 0.3s" x="88" y="16" width="32" height="32"
                                fill="none" stroke="var(--retro-white)" stroke-width="8" />
                            <!-- 'k' -->
                            <path class="snap-letter" style="animation-delay: 0.4s" fill="none"
                                stroke="var(--retro-cyan)" stroke-width="8"
                                d="M136 0 v48 M136 24 l24 -20 M136 24 l24 24" />
                            <!-- 'W' -->
                            <path class="snap-letter" style="animation-delay: 0.5s" fill="none"
                                stroke="var(--retro-white)" stroke-width="8" d="M172 0 v48 l16 -16 l16 16 v-48" />
                            <!-- 'i' -->
                            <g class="snap-letter" style="animation-delay: 0.6s">
                                <rect x="216" y="16" width="8" height="32" fill="var(--retro-cyan)" />
                                <rect x="216" y="0" width="8" height="8" fill="var(--retro-yellow)" />
                            </g>
                            <!-- 's' -->
                            <path class="snap-letter" style="animation-delay: 0.7s" fill="none"
                                stroke="var(--retro-magenta)" stroke-width="8" d="M236 16 h32 v12 h-32 v12 h32" />
                            <!-- 'e' -->
                            <path class="snap-letter" style="animation-delay: 0.8s" fill="none"
                                stroke="var(--retro-white)" stroke-width="8"
                                d="M280 16 h32 v32 h-32 v-32 M280 32 h32" />
                            <!-- Instant Sparkle SNAPS -->
                            <rect class="sparkle" style="animation-delay: 0.1s" x="0" y="24" width="8" height="8"
                                fill="var(--retro-yellow)" />
                        </g>
                    </svg>
                </div>
            </a>
            <div class="navbar-nav ms-auto">
                {% if session.user_id %}
                <span class="nav-link small lightgrey me-2">Hi, {{ session.username }}</span>
                <a class="nav-link" href="{{ url_for('main.index') }}">Endpoints</a>
                <a class="nav-link" href="{{ url_for('main.routing') }}" style="display:none;">Routing</a>
                <!-- Legacy link hidden -->
                <a class="nav-link" href="{{ url_for('main.tenantmap') }}">TenantMap</a>
                <a class="nav-link" href="{{ url_for('main.history') }}">History</a>
                <a class="nav-link" href="{{ url_for('main.audit_logs') }}">Audit</a>
                <a class="nav-link" href="{{ url_for('main.settings') }}">Settings</a>
                <a class="nav-link" href="{{ url_for('main.logout') }}">Logout</a>
                {% else %}
                <!-- Login removed from navbar as all pages are protected -->
                {% endif %}
                <a class="nav-link" href="#" data-bs-toggle="offcanvas" data-bs-target="#docsSidebar">Docs</a>
                <a class="nav-link" href="{{ url_for('main.new_endpoint') }}">New Endpoint</a>
            </div>
        </div>
    </nav>
    {% endif %}

    <!-- Documentation Sidebar -->
    <div class="offcanvas offcanvas-end bg-dark text-white border-start border-secondary border-opacity-25"
        tabindex="-1" id="docsSidebar" style="width: 400px;">
        <div class="offcanvas-header border-bottom border-secondary border-opacity-10">
            <h5 class="offcanvas-title fw-bold text-primary">Documentation</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="offcanvas"></button>
        </div>
        <div class="offcanvas-body">
            <h6 class="fw-bold text-info mb-3">Getting Started</h6>
            <p class="small text-secondary">To start routing alerts, create an endpoint and use the generated URL in
                your monitoring tool (e.g. Uptime Kuma).</p>

            <h6 class="fw-bold text-info mt-4 mb-3">Authentication</h6>
            <p class="small text-secondary">Every request must include the
                <code>Authorization: Bearer &lt;token&gt;</code> header.
            </p>

            <h6 class="fw-bold text-info mt-4 mb-3">Smart Parsing</h6>
            <p class="small text-secondary">Include <code>#CW&lt;CompanyIdentifier&gt;</code> in your alert title to
                automatically route to a specific client.</p>

            <h6 class="fw-bold text-info mt-4 mb-3">JSONPath Mappings</h6>
            <p class="small text-secondary">Use dot notation (e.g. <code>$.monitor.status</code>) to map payload fields
                to ticket fields.</p>

            <hr class="my-4 border-secondary border-opacity-10">
            <div class="alert alert-info bg-opacity-10 border-info border-opacity-25 py-2">
                <p class="mb-0 small text-info">Need more help? Check the <a href="https://github.com/arumes31/hookwise"
                        target="_blank" class="fw-bold">GitHub Repository</a>.</p>
            </div>
        </div>
    </div>

    <div id="toast-container"></div>

    <!-- Modern Confirmation Modal -->
    <div class="modal fade" id="hw-confirm-modal" tabindex="-1" aria-hidden="true" style="z-index: 9999;">
        <div class="modal-dialog modal-dialog-centered">
            <div class="glass-card shadow-lg border-0 w-100 p-1" style="max-width: 400px; margin: auto;">
                <div class="p-4 text-center">
                    <div class="hw-logo-container mb-3 opacity-50" style="transform: scale(0.6);">
                        <svg class="logo-8bit-svg" viewBox="0 0 400 80">
                            <g class="word-group" transform="translate(42, 16)">
                                <path fill="none" stroke="var(--retro-cyan)" stroke-width="8"
                                    d="M4 0 v48 M4 24 h24 M28 0 v48" />
                                <rect x="44" y="16" width="32" height="32" fill="none" stroke="var(--retro-white)"
                                    stroke-width="8" />
                                <rect x="88" y="16" width="32" height="32" fill="none" stroke="var(--retro-white)"
                                    stroke-width="8" />
                                <path fill="none" stroke="var(--retro-cyan)" stroke-width="8"
                                    d="M136 0 v48 M136 24 l24 -20 M136 24 l24 24" />
                                <path fill="none" stroke="var(--retro-white)" stroke-width="8"
                                    d="M172 0 v48 l16 -16 l16 16 v-48" />
                            </g>
                        </svg>
                    </div>
                    <h5 id="hw-confirm-title" class="fw-bold text-light mb-3 h5">Confirm Action</h5>
                    <p id="hw-confirm-message" class="text-secondary small mb-4">Are you sure you want to proceed?</p>
                    <div class="d-flex gap-2">
                        <button type="button" class="btn btn-dark border-secondary text-secondary fw-bold flex-grow-1"
                            data-bs-dismiss="modal" id="hw-confirm-cancel">Cancel</button>
                        <button type="button" class="btn btn-primary fw-bold flex-grow-1"
                            id="hw-confirm-ok">Confirm</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="container pb-5">
        {% with messages = get_flashed_messages() %}
        {% if messages %}
        {% for message in messages %}
        <div class="alert alert-info alert-dismissible fade show" role="alert">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
        {% endfor %}
        {% endif %}
        {% endwith %}

        {% block content %}{% endblock %}
    </div>

    <!-- Feedback Removed -->

    <button id="back-to-top" class="btn btn-primary position-fixed bottom-0 end-0 m-4 rounded-circle shadow-lg d-none"
        style="z-index: 1050; width: 45px; height: 45px;" onclick="window.scrollTo({top: 0, behavior: 'smooth'})">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-arrow-up"
            viewBox="0 0 16 16">
            <path fill-rule="evenodd"
                d="M8 15a.5.5 0 0 0 .5-.5V2.707l3.146 3.147a.5.5 0 0 0 .708-.708l-4-4a.5.5 0 0 0-.708 0l-4 4a.5.5 0 1 0 .708.708L7.5 2.707V14.5a.5.5 0 0 0 .5.5z" />
        </svg>
    </button>

    {% if request.endpoint != 'main.login' %}
    <footer class="footer mt-auto py-3 bg-dark bg-opacity-50 border-top border-secondary border-opacity-10">
        <div class="container d-flex justify-content-between align-items-center">
            <span class="text-secondary small">&copy; 2026 HookWise</span>
            <div class="health-indicators">
                <span class="text-secondary small me-3">
                    <span id="health-redis" class="heartbeat-dot heartbeat-warning"></span> Redis
                </span>
                <span class="text-secondary small me-3">
                    <span id="health-database" class="heartbeat-dot heartbeat-warning"></span> DB
                </span>
                <span class="text-secondary small">
                    <span id="health-celery" class="heartbeat-dot heartbeat-warning"></span> Celery
                </span>
            </div>
        </div>
    </footer>
    {% endif %}

    <script src="{{ url_for('static', filename='js/bootstrap.bundle.min.js') }}"></script>
    <script src="{{ url_for('static', filename='js/socket.io.min.js') }}"></script>
    <script src="{{ url_for('static', filename='js/prism.js') }}"></script>
    <script src="{{ url_for('static', filename='js/mini-charts.js') }}"></script>
    <script src="{{ url_for('static', filename='js/htmx.min.js') }}"></script>
    <script src="{{ url_for('static', filename='js/ux.js') }}"></script>
</body>

</html>