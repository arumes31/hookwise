{% extends 'base.html' %}

{% block content %}
<canvas id="bg-animation"></canvas>

<div class="row justify-content-center align-items-center" style="min-height: 100vh; overflow-x: hidden; margin: 0;">
    <div class="col-md-5 col-lg-4">
        <div class="glass-card shadow-premium p-4 p-md-5">
            <div class="text-center mb-4">
                <div class="hw-logo-container justify-content-center mb-3">
                    <svg class="logo-8bit-svg" style="height: 100px;" viewBox="0 0 320 80"
                        xmlns="http://www.w3.org/2000/svg">
                        <!-- CRT Scanline (Background) -->
                        <rect class="retro-scanline" x="0" y="0" width="320" height="4" />

                        <!-- Phase 1: Falling Garbage (Random bits) -->
                        <g class="falling-garbage">
                            <rect x="60" y="-20" width="8" height="8" class="falling-piece"
                                fill="var(--retro-magenta)" />
                            <path d="M120 -40 h12 v12 h-12 z" class="falling-piece" style="animation-delay: 0.2s"
                                fill="var(--retro-cyan)" />
                            <rect x="200" y="-10" width="10" height="4" class="falling-piece"
                                style="animation-delay: 0.5s" fill="var(--retro-yellow)" />
                        </g>

                        <!-- Phase 3: High-Legibility Word Group -->
                        <g class="word-group tugged logo-settled" transform="translate(30, 20)">
                            <!-- 'h' -->
                            <path class="snap-letter" style="animation-delay: 2.1s" fill="none"
                                stroke="var(--retro-cyan)" stroke-width="8" d="M4 0 v48 M4 24 h24 v24" />
                            <!-- 'o' -->
                            <rect class="snap-letter" style="animation-delay: 2.3s" x="44" y="16" width="32" height="32"
                                fill="none" stroke="var(--retro-white)" stroke-width="8" />
                            <!-- 'o' -->
                            <rect class="snap-letter" style="animation-delay: 2.5s" x="88" y="16" width="32" height="32"
                                fill="none" stroke="var(--retro-white)" stroke-width="8" />
                            <!-- 'k' -->
                            <path class="snap-letter" style="animation-delay: 2.7s" fill="none"
                                stroke="var(--retro-cyan)" stroke-width="8"
                                d="M136 0 v48 M136 24 l24 -20 M136 24 l24 24" />
                            <!-- 'w' -->
                            <path class="snap-letter w-bounce" style="animation-delay: 2.9s" fill="none"
                                stroke="var(--retro-white)" stroke-width="8" d="M172 16 v32 l16 -16 l16 16 v-32" />
                            <!-- 'i' -->
                            <g class="snap-letter" style="animation-delay: 3.1s">
                                <rect x="216" y="16" width="8" height="32" fill="var(--retro-cyan)" />
                                <rect class="i-dot-fall" x="216" y="0" width="8" height="8"
                                    fill="var(--retro-yellow)" />
                            </g>
                            <!-- 's' -->
                            <path class="snap-letter" style="animation-delay: 3.3s" fill="none"
                                stroke="var(--retro-magenta)" stroke-width="8" d="M236 16 h32 v12 h-32 v12 h32" />
                            <!-- 'e' -->
                            <path class="snap-letter" style="animation-delay: 3.5s" fill="none"
                                stroke="var(--retro-white)" stroke-width="8"
                                d="M280 16 h32 v32 h-32 v-32 M280 32 h32" />

                            <!-- Sparkle SNAPS -->
                            <rect class="sparkle" style="animation-delay: 2.1s" x="0" y="24" width="8" height="8"
                                fill="var(--retro-yellow)" />
                            <rect class="sparkle" style="animation-delay: 2.9s" x="180" y="32" width="8" height="8"
                                fill="var(--retro-cyan)" />
                        </g>

                        <!-- Phase 4: Re-designed Hook -->
                        <g class="retro-hook" transform="translate(260, 45)">
                            <path d="M0 -45 v50 c0 20 25 20 25 5 l -8 6" fill="none" stroke="var(--retro-white)"
                                stroke-width="8" stroke-linecap="square" />
                            <rect x="22" y="5" width="8" height="8" fill="var(--retro-yellow)" />
                        </g>

                        <!-- Tagline (v2 Spacing) -->
                        <g font-family="'Courier New', monospace" font-weight="bold" font-size="12"
                            transform="translate(35, 75)">
                            <text x="0" y="0" class="tagline-char" style="animation-delay: 7.5s"
                                fill="var(--retro-white)">H</text>
                            <text x="10" y="0" class="tagline-char" style="animation-delay: 7.6s"
                                fill="var(--retro-white)">O</text>
                            <text x="20" y="0" class="tagline-char" style="animation-delay: 7.7s"
                                fill="var(--retro-white)">O</text>
                            <text x="30" y="0" class="tagline-char" style="animation-delay: 7.8s"
                                fill="var(--retro-white)">K</text>

                            <text x="45" y="0" class="tagline-char" style="animation-delay: 8.0s"
                                fill="var(--retro-cyan)">L</text>
                            <text x="55" y="0" class="tagline-char" style="animation-delay: 8.1s"
                                fill="var(--retro-cyan)">I</text>
                            <text x="65" y="0" class="tagline-char" style="animation-delay: 8.2s"
                                fill="var(--retro-cyan)">N</text>
                            <text x="75" y="0" class="tagline-char" style="animation-delay: 8.3s"
                                fill="var(--retro-cyan)">E</text>

                            <text x="90" y="0" class="tagline-char" style="animation-delay: 8.5s"
                                fill="var(--retro-white)">C</text>
                            <text x="100" y="0" class="tagline-char" style="animation-delay: 8.6s"
                                fill="var(--retro-white)">O</text>
                            <text x="110" y="0" class="tagline-char" style="animation-delay: 8.7s"
                                fill="var(--retro-white)">N</text>
                            <text x="120" y="0" class="tagline-char" style="animation-delay: 8.8s"
                                fill="var(--retro-white)">N</text>
                            <text x="130" y="0" class="tagline-char" style="animation-delay: 8.9s"
                                fill="var(--retro-white)">E</text>
                            <text x="140" y="0" class="tagline-char" style="animation-delay: 9.0s"
                                fill="var(--retro-white)">C</text>
                            <text x="150" y="0" class="tagline-char" style="animation-delay: 9.1s"
                                fill="var(--retro-white)">T</text>
                        </g>
                    </svg>
                </div>

                {% if step == '2fa' %}
                <h4 class="mb-0 fw-bold accent-gradient">Two-Factor Auth</h4>
                {% else %}
                <h4 class="mb-0 fw-bold accent-gradient">Login to HookWise</h4>
                {% endif %}
            </div>

            <form method="POST" id="login-form">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />

                {% if step == '2fa' %}
                <p class="text-secondary text-center mb-4">Enter the 6-digit code from your authenticator app.</p>
                <div class="mb-4">
                    <input type="text"
                        class="form-control form-control-lg text-center font-monospace ls-wide bg-dark bg-opacity-50 border-secondary text-light"
                        style="letter-spacing: 0.5em; font-size: 1.5rem;" id="otp" name="otp" placeholder="000000"
                        required autofocus autocomplete="one-time-code" maxlength="6">
                </div>
                <div class="d-grid mb-3">
                    <button type="submit" class="btn btn-primary btn-lg fw-bold shadow-lg" id="submit-btn">
                        <span class="btn-text">Verify Code</span>
                        <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
                    </button>
                </div>
                <div class="text-center">
                    <a href="{{ url_for('main.login') }}"
                        class="text-secondary small text-decoration-none hover-text-primary transition-colors">
                        &larr; Back to Login
                    </a>
                </div>
                {% else %}
                <div class="mb-3">
                    <label for="username" class="form-label small fw-bold text-secondary ls-wide">USERNAME</label>
                    <input type="text" class="form-control bg-dark bg-opacity-50 border-secondary text-light"
                        id="username" name="username" required autofocus placeholder="Enter your username">
                </div>
                <div class="mb-4">
                    <label for="password" class="form-label small fw-bold text-secondary ls-wide">PASSWORD</label>
                    <div class="input-group">
                        <input type="password"
                            class="form-control bg-dark bg-opacity-50 border-secondary text-light border-end-0"
                            id="password" name="password" required placeholder="Enter your password">
                        <button
                            class="btn btn-outline-secondary bg-dark bg-opacity-50 border-secondary border-start-0 text-secondary"
                            type="button" id="toggle-password">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                                class="bi bi-eye" viewBox="0 0 16 16" id="eye-icon">
                                <path
                                    d="M16 8s-3-5.5-8-5.5S0 8 0 8s3 5.5 8 5.5S16 8 16 8zM1.173 8a13.133 13.133 0 0 1 1.66-2.043C4.12 4.668 5.88 3.5 8 3.5c2.12 0 3.879 1.168 5.168 2.457A13.133 13.133 0 0 1 14.828 8c-.058.087-.122.183-.195.288-.335.48-.83 1.12-1.465 1.755C11.879 11.332 10.119 12.5 8 12.5c-2.12 0-3.879-1.168-5.168-2.457A13.134 13.134 0 0 1 1.172 8z" />
                                <path
                                    d="M8 5.5a2.5 2.5 0 1 0 0 5 2.5 2.5 0 0 0 0-5zM4.5 8a3.5 3.5 0 1 1 7 0 3.5 3.5 0 0 1-7 0z" />
                            </svg>
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                                class="bi bi-eye-slash d-none" viewBox="0 0 16 16" id="eye-slash-icon">
                                <path
                                    d="M13.359 11.238C15.06 9.72 16 8 16 8s-3-5.5-8-5.5a7.028 7.028 0 0 0-2.79.588l.77.771A5.944 5.944 0 0 1 8 3.5c2.12 0 3.879 1.168 5.168 2.457A13.134 13.134 0 0 1 14.828 8c-.058.087-.122.183-.195.288-.335.48-.83 1.12-1.465 1.755-.165.165-.337.328-.517.486l.708.709z" />
                                <path
                                    d="M11.297 9.32l.766.766a2.775 2.775 0 0 1-4.31.03l2.884-2.884a2.775 2.775 0 0 1 .66.766zm-4.296-4.296L8.258 6.65a2.775 2.775 0 0 1 4.52 4.52l3.65 3.65a.5.5 0 0 1-.708.708l-12-12a.5.5 0 0 1 .708 0l1.5 1.5z" />
                            </svg>
                        </button>
                    </div>
                </div>
                <div class="d-grid gap-2">
                    <button type="submit" class="btn btn-primary btn-lg fw-bold shadow-lg" id="submit-btn">
                        <span class="btn-text">Sign In</span>
                        <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
                    </button>
                </div>
                {% endif %}
            </form>
        </div>


    </div>
</div>

<script src="{{ url_for('static', filename='js/login-animation.js') }}"></script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Password Toggle
        const toggleBtn = document.getElementById('toggle-password');
        const passwordInput = document.getElementById('password');
        const eyeIcon = document.getElementById('eye-icon');
        const eyeSlashIcon = document.getElementById('eye-slash-icon');

        if (toggleBtn) {
            toggleBtn.addEventListener('click', function () {
                const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
                passwordInput.setAttribute('type', type);
                eyeIcon.classList.toggle('d-none');
                eyeSlashIcon.classList.toggle('d-none');
            });
        }

        // Loading State
        const form = document.getElementById('login-form');
        const submitBtn = document.getElementById('submit-btn');

        if (form) {
            form.addEventListener('submit', function () {
                if (submitBtn) {
                    submitBtn.disabled = true;
                    submitBtn.querySelector('.btn-text').textContent = 'Signing In...';
                    submitBtn.querySelector('.spinner-border').classList.remove('d-none');
                }
            });
        }
    });
</script>
{% endblock %}