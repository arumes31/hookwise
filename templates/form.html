{% extends 'base.html' %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-8">
        <div class="card border-0">
            <div class="card-header bg-primary text-white p-4">
                <h2 class="mb-0 h4 fw-bold">{{ 'Edit' if config else 'New' }} Webhook Endpoint</h2>
                <p class="mb-0 small opacity-75">{{ 'Update your existing webhook routing configuration.' if config else
                    'Configure how incoming alerts are routed to ConnectWise.' }}</p>
            </div>
            <div class="card-body p-4">
                <form method="POST">
                    <div class="mb-3">
                        <label for="name" class="form-label fw-bold">Endpoint Name <span
                                class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="name" name="name"
                            placeholder="e.g. Uptime Kuma Production" required
                            value="{{ config.name if config else '' }}"
                            data-tooltip="A descriptive name for this webhook source.">
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="ticket_prefix" class="form-label">Ticket Summary Prefix</label>
                            <input type="text" class="form-control" id="ticket_prefix" name="ticket_prefix"
                                placeholder="e.g. Alert:" value="{{ config.ticket_prefix if config else '' }}"
                                data-tooltip="Optional text to prepend to the ConnectWise ticket title.">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="board" class="form-label">Service Board</label>
                            <select class="form-select" id="board" name="board" data-tooltip="The ConnectWise Service Board name where tickets will be created.">
                                <option value="">Loading...</option>
                            </select>
                            <input type="hidden" id="board_hidden" value="{{ config.board if config else '' }}">
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="customer_id_default" class="form-label">Default Customer ID</label>
                            <input class="form-control" list="company_list" id="customer_id_default" name="customer_id_default" 
                                placeholder="Search or type Identifier" value="{{ config.customer_id_default if config else '' }}"
                                data-tooltip="The ConnectWise Company ID to use if not found in the payload.">
                            <datalist id="company_list"></datalist>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="status" class="form-label">Initial Status</label>
                            <input type="text" class="form-control" id="status" name="status" placeholder="Optional"
                                value="{{ config.status if config else '' }}"
                                data-tooltip="The status name to set on new tickets.">
                        </div>
                    </div>

            <div class="row">
                <div class="col-md-6 mb-3">
                    <label for="priority" class="form-label">Priority</label>
                    <select class="form-select" id="priority" name="priority" data-tooltip="The priority name to set on new tickets.">
                        <option value="">Loading...</option>
                    </select>
                    <input type="hidden" id="priority_hidden" value="{{ config.priority if config else '' }}">
                </div>
                <div class="col-md-6 mb-3">
                    <label for="trusted_ips" class="form-label">Trusted IPs (Optional)</label>
                    <input type="text" class="form-control" id="trusted_ips" name="trusted_ips" placeholder="e.g. 192.168.1.0/24, 10.0.0.1"
                        value="{{ config.trusted_ips if config else '' }}"
                        data-tooltip="Comma-separated list of allowed IPs or CIDRs. Leave empty for all.">
                </div>
            </div>
            </div>

            <div class="mb-3">
                <label for="json_mapping" class="form-label fw-bold">JSON Field Mapping (JSON)</label>
                <textarea class="form-control font-monospace small" id="json_mapping" name="json_mapping" rows="3"
                    placeholder='{"summary": "$.title", "description": "$.msg", "customer_id": "$.client_id"}'
                    data-tooltip="Override ConnectWise fields using JSONPath expressions.">{{ config.json_mapping if config else '' }}</textarea>
                <div class="form-text small opacity-75">Map payload fields to CW summary, description, or customer_id.
                </div>
            </div>

            <div class="mb-3">
                <label for="maintenance_windows" class="form-label fw-bold">Maintenance Windows (JSON Array)</label>
                <textarea class="form-control font-monospace small" id="maintenance_windows" name="maintenance_windows" rows="2"
                    placeholder='[{"start": "2026-01-01T00:00:00Z", "end": "2026-01-01T01:00:00Z"}]'
                    data-tooltip="Define periods where webhooks are received but not forwarded to ConnectWise.">{{ config.maintenance_windows if config else '' }}</textarea>
                <div class="form-text small opacity-75">JSON array of start/end ISO timestamps.</div>
            </div>

            <div class="mb-3">
                <label for="routing_rules" class="form-label fw-bold">Regex Routing Rules (JSON Array)</label>
                <textarea class="form-control font-monospace small" id="routing_rules" name="routing_rules" rows="3"
                    placeholder='[{"path": "$.status", "regex": "critical", "overrides": {"board": "Critical"}}]'
                    data-tooltip="Define regex rules to override endpoint settings based on payload content.">{{ config.routing_rules if config else '' }}</textarea>
                <div class="form-text small opacity-75">Overrides board, status, priority, type or subtype if regex
                    matches.</div>
            </div>

            <hr class="my-4 opacity-10">

            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="mb-0 fw-bold">Trigger Configuration</h5>
                <button type="button" class="btn btn-sm btn-outline-info" data-bs-toggle="collapse"
                    data-bs-target="#validator-tool">
                    Test JSON Path
                </button>
            </div>

            <div class="collapse mb-4" id="validator-tool">
                <div class="card bg-black bg-opacity-50 border-info border-opacity-25 card-body p-3">
                    <label class="small text-info fw-bold mb-2">JSON PATH VALIDATOR</label>
                    <textarea id="sample-json" class="form-control bg-dark border-secondary text-info small mb-2"
                        rows="4" placeholder='Paste sample JSON here... e.g. {"heartbeat": {"status": 0}}'></textarea>
                    <button type="button" class="btn btn-sm btn-info text-dark fw-bold w-100"
                        onclick="testPath()">Validate Path</button>
                    <div id="validation-result"></div>
                </div>
            </div>

            <div class="mb-3">
                <label for="trigger_field" class="form-label fw-bold">JSON Trigger Field <span
                        class="text-danger">*</span></label>
                <input type="text" class="form-control" id="trigger_field" name="trigger_field"
                    placeholder="heartbeat.status" value="{{ config.trigger_field if config else 'heartbeat.status' }}"
                    required
                    data-tooltip="Use dot-notation to specify the field in the webhook body (e.g., monitor.status).">
            </div>

            <div class="row">
                <div class="col-md-6 mb-3">
                    <label for="open_value" class="form-label fw-bold">Open Value(s) <span
                            class="text-danger">*</span></label>
                    <input type="text" class="form-control" id="open_value" name="open_value" placeholder="0, down"
                        value="{{ config.open_value if config else '0' }}" required
                        data-tooltip="Comma-separated list of values that mean 'Fail'.">
                </div>
                <div class="col-md-6 mb-3">
                    <label for="close_value" class="form-label fw-bold">Close Value(s) <span
                            class="text-danger">*</span></label>
                    <input type="text" class="form-control" id="close_value" name="close_value" placeholder="1, up"
                        value="{{ config.close_value if config else '1' }}" required
                        data-tooltip="Comma-separated list of values that mean 'Success'.">
                </div>
            </div>

            <div class="d-grid gap-2 d-md-flex justify-content-md-end mt-4">
                <a href="{{ url_for('main.index') }}" class="btn btn-outline-secondary px-4">Cancel</a>
                <button type="submit" class="btn btn-primary px-4">{{ 'Save Changes' if config else 'Create
                    Endpoint' }}</button>
            </div>
                        </form>
                    </div>
                </div>
            </div>
            </div>
            
            <script>
                document.addEventListener('DOMContentLoaded', async () => {
                    const boardSelect = document.getElementById('board');
                    const prioritySelect = document.getElementById('priority');
                    const boardHidden = document.getElementById('board_hidden').value;
                    const priorityHidden = document.getElementById('priority_hidden').value;
            
                    // Fetch Boards
                    try {
                        const res = await fetch('/api/cw/boards');
                        const boards = await res.json();
                        boardSelect.innerHTML = '<option value="">-- Use Default --</option>';
                        boards.forEach(b => {
                            const opt = document.createElement('option');
                            opt.value = b.name;
                            opt.textContent = b.name;
                            if (b.name === boardHidden) opt.selected = true;
                            boardSelect.appendChild(opt);
                        });
                    } catch (e) {
                        boardSelect.innerHTML = '<option value="">Error loading boards</option>';
                    }
            
                    // Fetch Priorities
                    try {
                        const res = await fetch('/api/cw/priorities');
                        const priorities = await res.json();
                        prioritySelect.innerHTML = '<option value="">-- Use Default --</option>';
                        priorities.forEach(p => {
                            const opt = document.createElement('option');
                            opt.value = p.name;
                            opt.textContent = p.name;
                            if (p.name === priorityHidden) opt.selected = true;
                            prioritySelect.appendChild(opt);
                        });
                    } catch (e) {
                        prioritySelect.innerHTML = '<option value="">Error loading priorities</option>';
                    }
            
                    // Fetch Companies (first 50)
                    try {
                        const res = await fetch('/api/cw/companies');
                        const companies = await res.json();
                        const datalist = document.getElementById('company_list');
                        companies.forEach(c => {
                            const opt = document.createElement('option');
                            opt.value = c.identifier;
                            opt.textContent = c.name;
                            datalist.appendChild(opt);
                        });
                    } catch (e) {
                        console.error('Error loading companies', e);
                    }
                });
            </script>
            {% endblock %}
            