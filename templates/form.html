{% extends 'base.html' %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-xl-10">
        <nav aria-label="breadcrumb" class="mb-4">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="{{ url_for('main.index') }}"
                        class="text-decoration-none text-info">Dashboard</a></li>
                <li class="breadcrumb-item active text-secondary" aria-current="page">{{ 'Edit' if config else 'New' }}
                    Endpoint</li>
            </ol>
        </nav>

        <div class="glass-card mb-5 anime-slide-up">
            <div class="card-header border-bottom border-secondary border-opacity-25 p-4 bg-transparent">
                <div class="d-flex justify-content-between align-items-center">
                    <div class="d-flex align-items-center">
                        <div class="d-inline-flex align-items-center justify-content-center bg-primary bg-opacity-10 rounded-circle me-3"
                            style="width: 48px; height: 48px;">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor"
                                class="bi bi-bezier2 text-primary" viewBox="0 0 16 16">
                                <path fill-rule="evenodd"
                                    d="M1 2.5A1.5 1.5 0 0 1 2.5 1h1A1.5 1.5 0 0 1 5 2.5h4.134a1 1 0 1 1 0 1h-1.205a2.5 2.5 0 0 1-.486 1.879l-1.025 1.25a2.49 2.49 0 0 1 1.087 1.93l.386 2.316a1 1 0 1 1-1.972.33l-.386-2.315a1.5 1.5 0 0 0-.812-1.088l-1.902-2.315A2.49 2.49 0 0 1 1.25 3h-.5a1.5 1.5 0 0 1 0-3h1zm3.844 7.644-2.846-3.468A1.49 1.49 0 0 0 1 7.5v1a1.5 1.5 0 0 0 1.28 1.484l2.564.428zM14.5 13.5a1.5 1.5 0 1 0-3 0 1.5 1.5 0 0 0 3 0zM8.5 2.5a.5.5 0 1 0-1 0 .5.5 0 0 0 1 0z" />
                                <path fill-rule="evenodd"
                                    d="M10 2.5a1.5 1.5 0 1 1 3 0 1.5 1.5 0 0 1-3 0zm-7 11a1.5 1.5 0 1 1 3 0 1.5 1.5 0 0 1-3 0z" />
                            </svg>
                        </div>
                        <div>
                            <h2 class="mb-0 h4 fw-bold text-light">{{ 'Edit' if config else 'New' }} Webhook Endpoint
                            </h2>
                            <p class="mb-0 small text-secondary">{{ 'Update your existing webhook routing
                                configuration.' if config else 'Configure how incoming alerts are routed to
                                ConnectWise.' }}</p>
                        </div>
                    </div>
                    <a href="{{ url_for('main.index') }}" class="btn btn-outline-secondary btn-sm">Back to Dashboard</a>
                </div>
            </div>
            <div class="card-body p-4">
                <form method="POST" id="endpoint-form">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                    <div class="row g-5">
                        <!-- Left Column: Core Configuration -->
                        <div class="col-lg-6 border-end border-secondary border-opacity-10">

                            <div class="mb-4 rounded-3 p-3 position-relative overflow-hidden"
                                style="background: linear-gradient(135deg, rgba(13, 27, 42, 0.8), rgba(27, 40, 56, 0.8)); border: 1px solid rgba(88, 166, 255, 0.3);">
                                <div class="position-absolute top-0 start-0 bottom-0 bg-primary" style="width: 4px;">
                                </div>
                                <small class="d-block mb-1 fw-bold text-uppercase ls-1"
                                    style="color: #58a6ff; font-size: 0.7rem;">PREVIEW: CW TICKET SUMMARY</small>
                                <div id="summary-preview" class="font-monospace text-light"
                                    style="font-size: 1.1rem; font-weight: 600;">Prefix: Source Name</div>
                            </div>

                            <div
                                class="d-flex justify-content-between align-items-center mb-4 border-bottom pb-2 border-secondary border-opacity-25">
                                <h5 class="fw-bold mb-0 text-light">Core Settings</h5>
                                <div class="btn-group btn-group-sm">
                                    <button type="button" class="btn btn-outline-secondary" onclick="undo()"
                                        id="undo-btn" disabled><i class="fas fa-undo me-1"></i>Undo</button>
                                    <button type="button" class="btn btn-outline-secondary" onclick="redo()"
                                        id="redo-btn" disabled><i class="fas fa-redo me-1"></i>Redo</button>
                                </div>
                            </div>

                            <div class="mb-4">
                                <label for="name" class="form-label fw-bold text-light">Endpoint Name <span
                                        class="text-danger">*</span></label>
                                <input type="text" class="form-control bg-dark border-secondary text-light" id="name"
                                    name="name" placeholder="e.g. Uptime Kuma Production" required
                                    value="{{ config.name if config else '' }}"
                                    data-tooltip="A descriptive name for this webhook source.">
                            </div>

                            <div class="row">
                                <div class="col-md-6 mb-4">
                                    <label for="board" class="form-label fw-bold text-light">Service Board</label>
                                    <select class="form-select bg-dark border-secondary text-light" id="board"
                                        name="board"
                                        data-tooltip="The ConnectWise Service Board where tickets will be created.">
                                        <option value="">Loading...</option>
                                    </select>
                                    <input type="hidden" id="board_hidden" value="{{ config.board if config else '' }}">
                                </div>
                                <div class="col-md-6 mb-4">
                                    <label for="priority" class="form-label fw-bold text-light">Priority</label>
                                    <select class="form-select bg-dark border-secondary text-light" id="priority"
                                        name="priority" data-tooltip="The priority name to set on new tickets.">
                                        <option value="">Loading...</option>
                                    </select>
                                    <input type="hidden" id="priority_hidden"
                                        value="{{ config.priority if config else '' }}">
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-6 mb-4">
                                    <label for="customer_id_default" class="form-label fw-bold text-light">Default
                                        Company</label>
                                    <input class="form-control bg-dark border-secondary text-light" list="company_list"
                                        id="customer_id_default" name="customer_id_default"
                                        placeholder="Search Identifier"
                                        value="{{ config.customer_id_default if config else '' }}"
                                        data-tooltip="The ConnectWise Company ID to use if not found in the payload.">
                                    <datalist id="company_list"></datalist>
                                </div>
                                <div class="col-md-6 mb-4">
                                    <label for="status" class="form-label fw-bold text-light">Initial Status</label>
                                    <select class="form-select bg-dark border-secondary text-light" id="status"
                                        name="status" data-tooltip="The status to set on new tickets.">
                                        <option value="">-- Select Board First --</option>
                                    </select>
                                    <input type="hidden" id="status_hidden"
                                        value="{{ config.status if config else '' }}">
                                </div>
                            </div>

                            <div class="form-check form-switch mb-4">
                                <input class="form-check-input" type="checkbox" id="show-advanced"
                                    onchange="toggleAdvanced()">
                                <label class="form-check-label small text-secondary fw-bold text-uppercase ls-1"
                                    for="show-advanced">Show Advanced Fields</label>
                            </div>

                            <div id="advanced-fields"
                                class="d-none bg-dark bg-opacity-25 p-3 rounded mb-4 border border-secondary border-opacity-25">
                                <div class="row">
                                    <div class="col-md-4 mb-3">
                                        <label for="ticket_type"
                                            class="form-label fw-bold text-light small">Type</label>
                                        <select class="form-select form-select-sm bg-dark border-secondary text-light"
                                            id="ticket_type" name="ticket_type">
                                            <option value="">-- Select Board --</option>
                                        </select>
                                        <input type="hidden" id="type_hidden"
                                            value="{{ config.ticket_type if config else '' }}">
                                    </div>
                                    <div class="col-md-4 mb-3">
                                        <label for="subtype" class="form-label fw-bold text-light small">Subtype</label>
                                        <select class="form-select form-select-sm bg-dark border-secondary text-light"
                                            id="subtype" name="subtype">
                                            <option value="">-- Select Board --</option>
                                        </select>
                                        <input type="hidden" id="subtype_hidden"
                                            value="{{ config.subtype if config else '' }}">
                                    </div>
                                    <div class="col-md-4 mb-3">
                                        <label for="item" class="form-label fw-bold text-light small">Item</label>
                                        <select class="form-select form-select-sm bg-dark border-secondary text-light"
                                            id="item" name="item">
                                            <option value="">-- Select Board --</option>
                                        </select>
                                        <input type="hidden" id="item_hidden"
                                            value="{{ config.item if config else '' }}">
                                    </div>
                                </div>
                            </div>

                            <div class="mb-4">
                                <label for="ticket_prefix" class="form-label fw-bold text-light">Summary Prefix</label>
                                <input type="text" class="form-control bg-dark border-secondary text-light"
                                    id="ticket_prefix" name="ticket_prefix" placeholder="e.g. Alert:"
                                    value="{{ config.ticket_prefix if config else '' }}"
                                    data-tooltip="Text to prepend to the ConnectWise ticket title.">
                            </div>

                            <div class="mb-4">
                                <label for="trusted_ips" class="form-label fw-bold text-light">Trusted IPs
                                    (Optional)</label>
                                <input type="text"
                                    class="form-control font-monospace bg-dark border-secondary text-info small"
                                    id="trusted_ips" name="trusted_ips" placeholder="e.g. 192.168.1.0/24, 10.0.0.1"
                                    value="{{ config.trusted_ips if config else '' }}"
                                    data-tooltip="Comma-separated list of allowed IPs or CIDRs.">
                            </div>

                            <div class="mb-4">
                                <label for="hmac_secret" class="form-label fw-bold text-light">HMAC Secret
                                    (Optional)</label>
                                <input type="text"
                                    class="form-control font-monospace bg-dark border-secondary text-warning small"
                                    id="hmac_secret" name="hmac_secret" placeholder="Optional shared secret"
                                    value="{{ config.hmac_secret or '' if config else '' }}"
                                    data-tooltip="If set, incoming webhooks must include a valid X-HookWise-Signature header.">
                            </div>

                            <div class="form-check form-switch mb-4">
                                <input class="form-check-input" type="checkbox" role="switch" id="bearer_auth_enabled"
                                    name="bearer_auth_enabled" value="true" {{ 'checked' if not config.id or
                                    config.bearer_auth_enabled else '' }} onchange="toggleBearerMgmt()">
                                <label class="form-check-label fw-bold text-light" for="bearer_auth_enabled">
                                    Bearer Token Authentication
                                </label>
                                <div class="small text-secondary">
                                    Require an <code>Authorization: Bearer</code> header. Disable only if your source
                                    cannot send headers.
                                </div>
                            </div>

                            <div class="mb-4 p-3 rounded-2 bg-dark bg-opacity-50 border border-secondary border-opacity-25 {{ '' if (not config or config.bearer_auth_enabled) else 'd-none' }}"
                                id="token-mgmt-section">
                                <label class="form-label fw-bold text-light small d-block mb-2">Token Management</label>

                                {% if config and config.id %}
                                <div class="input-group input-group-sm mb-3">
                                    <input type="password"
                                        class="form-control bg-dark border-secondary text-info font-monospace"
                                        id="bearer-token-display" readonly value="****************">
                                    <button class="btn btn-outline-secondary" type="button"
                                        onclick="toggleTokenVisibility()" title="Reveal/Hide">
                                        <i class="fas fa-eye" id="token-eye-icon"></i>
                                    </button>
                                    <button class="btn btn-outline-info" type="button" onclick="copyBearerToken()"
                                        title="Copy to Clipboard">
                                        <i class="fas fa-copy"></i>
                                    </button>
                                </div>
                                <button type="button" class="btn btn-sm btn-outline-warning w-100 fw-bold"
                                    onclick="rotateBearerToken('{{ config.id }}')" id="rotate-btn">
                                    <i class="fas fa-sync-alt me-2"></i>Regenerate Bearer Token
                                </button>
                                <div class="small text-warning mt-2" style="font-size: 0.7rem;">
                                    <i class="fas fa-exclamation-triangle me-1"></i> Regeneration is immediate and stays
                                    rotated even if you cancel this form.
                                </div>
                                {% else %}
                                <div
                                    class="alert alert-info py-2 px-3 mb-0 small border-0 bg-info bg-opacity-10 text-info">
                                    <i class="fas fa-info-circle me-2"></i> A secure bearer token will be automatically
                                    generated and displayed here after you save this endpoint.
                                </div>
                                {% endif %}
                            </div>
                        </div>

                        <!-- Right Column: Advanced & Automation -->
                        <div class="col-lg-6">
                            <h5 class="fw-bold mb-4 border-bottom pb-2 border-secondary border-opacity-25 text-light">
                                Automation &
                                Logic</h5>

                            <div class="mb-4">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <label class="form-label fw-bold mb-0 text-light">Trigger Logic</label>
                                    <button type="button" class="btn btn-sm btn-outline-info" data-bs-toggle="collapse"
                                        data-bs-target="#debugger-tool">
                                        <i class="fas fa-bug me-1"></i>Open Step-through Debugger
                                    </button>
                                </div>

                                <div class="collapse mb-3" id="debugger-tool">
                                    <div
                                        class="rounded-3 bg-black bg-opacity-50 border border-info border-opacity-25 p-3">
                                        <label
                                            class="small preview-text fw-bold mb-2 text-info text-uppercase ls-1">Step-Through
                                            Debugger</label>
                                        <p class="small text-secondary mb-3">Paste a sample JSON payload below to
                                            simulate how HookWise would process this alert using your current
                                            configuration.</p>
                                        <textarea id="sample-json"
                                            class="form-control bg-dark border-secondary text-info small mb-2 font-monospace"
                                            rows="5" placeholder='Paste sample JSON here...'></textarea>
                                        <button type="button" class="btn btn-sm btn-info text-dark fw-bold w-100 mb-3"
                                            onclick="runDebugger()">Run Simulation</button>
                                        <div id="debugger-result" class="small"></div>
                                    </div>
                                </div>

                                <div class="input-group mb-2">
                                    <span
                                        class="input-group-text bg-dark border-secondary text-secondary small">Field</span>
                                    <input type="text"
                                        class="form-control font-monospace bg-dark border-secondary text-light"
                                        id="trigger_field" name="trigger_field" placeholder="heartbeat.status"
                                        value="{{ config.trigger_field if config else 'heartbeat.status' }}" required
                                        data-tooltip="Dot-notation path to the status field in webhook payload.">
                                </div>
                                <div class="row g-2">
                                    <div class="col-6">
                                        <div class="input-group input-group-sm">
                                            <span
                                                class="input-group-text bg-dark border-secondary text-danger small">Open</span>
                                            <input type="text" class="form-control bg-dark border-secondary text-light"
                                                id="open_value" name="open_value" placeholder="0"
                                                value="{{ config.open_value if config else '0' }}" required
                                                data-tooltip="Values that trigger a TICKET OPEN.">
                                        </div>
                                    </div>
                                    <div class="col-6">
                                        <div class="input-group input-group-sm">
                                            <span
                                                class="input-group-text bg-dark border-secondary text-success small">Close</span>
                                            <input type="text" class="form-control bg-dark border-secondary text-light"
                                                id="close_value" name="close_value" placeholder="1"
                                                value="{{ config.close_value if config else '1' }}" required
                                                data-tooltip="Values that trigger a TICKET CLOSE.">
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="mb-4">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <label for="description_template"
                                        class="form-label fw-bold mb-0 text-light">Description
                                        Template</label>
                                    <div class="dropdown">
                                        <button class="btn btn-sm btn-outline-secondary dropdown-toggle py-0 px-2"
                                            style="font-size: 0.75rem;" type="button" data-bs-toggle="dropdown">Insert
                                            Placeholder</button>
                                        <ul class="dropdown-menu dropdown-menu-dark small" style="font-size: 0.8rem;">
                                            <li><a class="dropdown-item" href="#"
                                                    onclick="return insertAtCursor(event, 'description_template', '{{ monitor_name }}')">Monitor
                                                    Name</a></li>
                                            <li><a class="dropdown-item" href="#"
                                                    onclick="return insertAtCursor(event, 'description_template', '{{ msg }}')">Message</a>
                                            </li>
                                            <li><a class="dropdown-item" href="#"
                                                    onclick="return insertAtCursor(event, 'description_template', '{{ request_id }}')">Request
                                                    ID</a></li>
                                            <li><a class="dropdown-item" href="#"
                                                    onclick="return insertAtCursor(event, 'description_template', '{$.path.to.field}')">JSONPath
                                                    Field</a></li>
                                        </ul>
                                    </div>
                                </div>
                                <textarea class="form-control font-monospace small bg-dark border-secondary text-light"
                                    id="description_template" name="description_template" rows="4"
                                    placeholder="Resource {{ monitor_name }} is experiencing issues.&#10;Message: {{ msg }}&#10;Path: {$.some.field}"
                                    data-tooltip="Custom ticket description using placeholders.">{{ config.description_template if config else '' }}</textarea>
                            </div>

                            <div class="mb-4">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <label for="json_mapping" class="form-label fw-bold mb-0 text-light">Field Mapping
                                        (JSON)</label>
                                    <div class="d-flex gap-2">
                                        <div class="dropdown">
                                            <button class="btn btn-sm btn-outline-secondary dropdown-toggle py-0 px-2"
                                                style="font-size: 0.75rem;" type="button"
                                                data-bs-toggle="dropdown">Insert Placeholder</button>
                                            <ul class="dropdown-menu dropdown-menu-dark small"
                                                style="font-size: 0.8rem;">
                                                <li><a class="dropdown-item" href="#"
                                                        onclick="return insertAtCursor(event, 'json_mapping', '{{ monitor_name }}')">Monitor
                                                        Name</a></li>
                                                <li><a class="dropdown-item" href="#"
                                                        onclick="return insertAtCursor(event, 'json_mapping', '{{ msg }}')">Message</a>
                                                </li>
                                                <li><a class="dropdown-item" href="#"
                                                        onclick="return insertAtCursor(event, 'json_mapping', '{{ request_id }}')">Request
                                                        ID</a></li>
                                                <li><a class="dropdown-item" href="#"
                                                        onclick="return insertAtCursor(event, 'json_mapping', '$.path.to.field')">JSONPath
                                                        Path</a></li>
                                            </ul>
                                        </div>
                                        <select
                                            class="form-select form-select-sm bg-dark border-secondary text-info py-0 px-2"
                                            style="font-size: 0.75rem; width: auto;"
                                            onchange="applyTemplate(this.value)">
                                            <option value="">Apply Template...</option>
                                            <option value="uptime_kuma">Uptime Kuma</option>
                                            <option value="grafana">Grafana</option>
                                            <option value="zabbix">Zabbix</option>
                                        </select>
                                        <button type="button"
                                            class="btn btn-sm btn-link text-info p-0 text-decoration-none"
                                            onclick="formatJSON('json_mapping')">Format</button>
                                    </div>
                                </div>
                                <textarea
                                    class="form-control font-monospace small bg-dark border-secondary text-warning"
                                    id="json_mapping" name="json_mapping" rows="3"
                                    placeholder='{"summary": "$.title", "description": "$.msg"}'
                                    data-tooltip="Override CW fields using JSONPath.">{{ config.json_mapping if config else '' }}</textarea>
                            </div>

                            <div class="mb-4">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <label for="routing_rules" class="form-label fw-bold mb-0 text-light">Regex Routing
                                        (JSON Array)</label>
                                    <button type="button" class="btn btn-sm btn-link text-info p-0 text-decoration-none"
                                        onclick="formatJSON('routing_rules')">Format</button>
                                </div>
                                <textarea
                                    class="form-control font-monospace small bg-dark border-secondary text-warning"
                                    id="routing_rules" name="routing_rules" rows="3"
                                    placeholder='[{"path": "$.status", "regex": "critical", "overrides": {"board": "Critical"}}]'
                                    data-tooltip="Dynamic routing based on payload content.">{{ config.routing_rules if config else '' }}</textarea>
                            </div>

                            <div class="mb-4 p-3 rounded-2 bg-gradient-custom-blue border border-primary border-opacity-25"
                                style="background: rgba(13, 110, 253, 0.05);">
                                <div class="form-check form-switch mb-3">
                                    <input class="form-check-input" type="checkbox" role="switch"
                                        id="global_routing_enabled" name="global_routing_enabled" value="true"
                                        {{ 'checked' if config and config.global_routing_enabled else '' }}>
                                    <label class="form-check-label fw-bold text-primary" for="global_routing_enabled">
                                        <i class="fas fa-project-diagram me-2"></i>GLOBAL TENANT MAPPING
                                    </label>
                                    <div class="small text-secondary mt-1">
                                        Resolve Company ID automatically via <a href="{{ url_for('main.tenantmap') }}"
                                            target="_blank" class="text-info text-decoration-none">TenantMap</a> lookup
                                        if not in payload.
                                    </div>
                                </div>

                                <div class="form-check form-switch mb-2">
                                    <input class="form-check-input" type="checkbox" role="switch" id="ai_rca_enabled"
                                        name="ai_rca_enabled" value="true" {{ 'checked' if config and
                                        config.ai_rca_enabled else '' }} onchange="toggleAI()">
                                    <label class="form-check-label fw-bold text-info" for="ai_rca_enabled">
                                        <i class="fas fa-robot me-2"></i>AUTOMATED RCA NOTES
                                    </label>
                                </div>

                                <div id="ai-settings"
                                    class="{{ '' if config and config.ai_rca_enabled else 'd-none' }}">
                                    <p class="small text-secondary mb-3">Uses local LLM (Phi-3) to intelligently suggest
                                        root causes based on alert context.</p>

                                    <label for="ai_prompt_template"
                                        class="form-label small fw-bold text-secondary text-uppercase ls-1">Custom AI
                                        Prompt (Original)</label>
                                    <textarea
                                        class="form-control font-monospace small bg-dark border-secondary text-light"
                                        id="ai_prompt_template" name="ai_prompt_template" rows="3"
                                        placeholder="Analyze this payload and select the best priority... ">{{ config.ai_prompt_template if config else '' }}</textarea>
                                </div>
                            </div>

                            <div class="mb-0">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <label class="form-label fw-bold mb-0 text-light">Maintenance Windows</label>
                                    <button type="button" class="btn btn-sm btn-outline-primary"
                                        onclick="addMaintenanceWindow()">Add Window</button>
                                </div>
                                <div id="maintenance-list" class="mb-2">
                                    <!-- Windows will be added here -->
                                </div>
                                <textarea class="d-none" id="maintenance_windows"
                                    name="maintenance_windows">{{ config.maintenance_windows if config else '' }}</textarea>
                            </div>
                        </div>
                    </div>

                    <hr class="my-5 border-secondary border-opacity-10">

                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            {% if config.id %}
                            <button type="button" class="btn btn-outline-danger px-4" id="delete-endpoint-btn"
                                data-id='{{ config.id|tojson }}' data-name='{{ config.name|tojson }}'
                                onclick="const btn=this; confirmDelete(JSON.parse(btn.dataset.id), JSON.parse(btn.dataset.name))">
                                <i class="fas fa-trash-alt me-2"></i>Delete Endpoint
                            </button>
                            {% endif %}
                        </div>
                        <div class="d-flex gap-3">
                            <input type="hidden" name="create_another" id="create_another" value="false">
                            <input type="hidden" name="is_draft" id="is_draft"
                                value="{{ 'true' if config.id and config.is_draft else 'false' }}">
                            <a href="{{ url_for('main.index') }}" class="btn btn-outline-secondary px-4">Cancel</a>
                            <button type="button" class="btn btn-outline-warning px-4" id="draft-btn"
                                onclick="saveAsDraft()">{{ 'Keep as Draft' if config.id and config.is_draft else 'Save
                                as
                                Draft' }}</button>
                            {% if not config.id %}
                            <button type="button" class="btn btn-outline-primary px-4" onclick="saveAndAnother()">Save &
                                Create Another</button>
                            {% endif %}
                            <button type="submit" class="btn btn-primary px-5 fw-bold shadow-lg"
                                onclick="document.getElementById('is_draft').value='false'">{{ 'Update Endpoint' if
                                config else 'Create Endpoint' }}</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
    const undoStack = [];
    const redoStack = [];
    let isUndoing = false;

    function saveState() {
        if (isUndoing) return;
        const form = document.getElementById('endpoint-form');
        const formData = new FormData(form);
        const state = {};
        formData.forEach((value, key) => state[key] = value);

        const stateStr = JSON.stringify(state);
        if (undoStack.length > 0 && undoStack[undoStack.length - 1] === stateStr) return;

        undoStack.push(stateStr);
        if (undoStack.length > 50) undoStack.shift();

        document.getElementById('undo-btn').disabled = undoStack.length < 2;
        redoStack.length = 0; // Clear redo on new action
        document.getElementById('redo-btn').disabled = true;
    }

    function undo() {
        if (undoStack.length < 2) return;
        isUndoing = true;
        const currentState = undoStack.pop();
        redoStack.push(currentState);
        const prevState = JSON.parse(undoStack[undoStack.length - 1]);
        applyState(prevState);
        document.getElementById('redo-btn').disabled = false;
        document.getElementById('undo-btn').disabled = undoStack.length < 2;
        isUndoing = false;
    }

    function redo() {
        if (!redoStack.length) return;
        isUndoing = true;
        const nextStateStr = redoStack.pop();
        undoStack.push(nextStateStr);
        applyState(JSON.parse(nextStateStr));
        document.getElementById('redo-btn').disabled = redoStack.length === 0;
        document.getElementById('undo-btn').disabled = false;
        isUndoing = false;
    }

    function applyState(state) {
        const form = document.getElementById('endpoint-form');
        Object.keys(state).forEach(key => {
            const el = form.elements[key];
            if (el && el.type !== 'file') el.value = state[key];
        });
        if (window.updatePreview) window.updatePreview();
        // Also sync maintenance windows if they changed
        const list = document.getElementById('maintenance-list');
        list.innerHTML = '';
        if (state.maintenance_windows) {
            try {
                const windows = JSON.parse(state.maintenance_windows);
                windows.forEach(w => addMaintenanceWindow(w));
            } catch (e) { }
        }
    }

    function toggleAdvanced() {
        const show = document.getElementById('show-advanced').checked;
        document.getElementById('advanced-fields').classList.toggle('d-none', !show);
    }

    function toggleBearerMgmt() {
        const checkbox = document.getElementById('bearer_auth_enabled');
        const section = document.getElementById('token-mgmt-section');
        if (section) {
            if (checkbox.checked) {
                section.classList.remove('d-none');
            } else {
                section.classList.add('d-none');
            }
        }
    }

    function toggleAI() {
        const rca = document.getElementById('ai_rca_enabled').checked;
        document.getElementById('ai-settings').classList.toggle('d-none', !rca);
    }

    function insertAtCursor(event, id, text) {
        if (event) event.preventDefault();
        const el = document.getElementById(id);
        if (!el) return;

        const start = el.selectionStart;
        const end = el.selectionEnd;
        const val = el.value;

        el.value = val.substring(0, start) + text + val.substring(end);
        el.selectionStart = el.selectionEnd = start + text.length;
        el.focus();

        // Trigger input event for autosave/preview
        el.dispatchEvent(new Event('input', { bubbles: true }));
        return false;
    }

    function addMaintenanceWindow(w = {}) {
        const list = document.getElementById('maintenance-list');
        const count = document.querySelectorAll('.maintenance-entry').length;
        const div = document.createElement('div');
        div.className = 'p-3 mb-3 rounded border border-secondary border-opacity-25 bg-dark bg-opacity-25 maintenance-entry';

        const type = w.type || 'once';
        const start = w.start || '';
        const end = w.end || '';
        const days = w.days || [];

        div.innerHTML = `
            <div class="row g-2 mb-3 align-items-center">
                <div class="col-md-4">
                    <select class="form-select form-select-sm mw-type bg-dark border-secondary text-info fw-bold" onchange="updateMWFields(this)">
                        <option value="once" ${type === 'once' ? 'selected' : ''}>One-time</option>
                        <option value="daily" ${type === 'daily' ? 'selected' : ''}>Daily</option>
                        <option value="weekly" ${type === 'weekly' ? 'selected' : ''}>Weekly</option>
                    </select>
                </div>
                <div class="col-md-8 text-end">
                    <button type="button" class="btn btn-sm btn-link text-danger p-0 fw-bold text-decoration-none" onclick="this.closest('.maintenance-entry').remove(); syncMaintenance();">
                        <i class="fas fa-times me-1"></i>Remove Window
                    </button>
                </div>
            </div>

            <div class="mw-fields">
                <!-- Days for Weekly -->
                <div class="mw-days-container mb-3 ${type === 'weekly' ? '' : 'd-none'}">
                    <label class="small text-secondary fw-bold text-uppercase ls-1 d-block mb-2">Days of Week (UTC)</label>
                    <div class="d-flex flex-wrap gap-2">
                        ${['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'].map(d => `
                            <div>
                                <input type="checkbox" class="btn-check mw-day" id="mw-${count}-${d}" value="${d}" ${days.includes(d) ? 'checked' : ''} onchange="syncMaintenance()">
                                <label class="btn btn-sm btn-outline-secondary px-2 py-1" for="mw-${count}-${d}" style="font-size: 0.7rem;">${d}</label>
                            </div>
                        `).join('')}
                    </div>
                </div>

                <div class="row g-2">
                    <div class="col-6">
                        <label class="small text-secondary fw-bold text-uppercase ls-1 d-block mb-1">Start (UTC)</label>
                        <input type="${type === 'once' ? 'datetime-local' : 'time'}" 
                               class="form-control form-control-sm mw-start bg-dark border-secondary text-light" 
                               value="${start}" onchange="syncMaintenance()">
                    </div>
                    <div class="col-6">
                        <label class="small text-secondary fw-bold text-uppercase ls-1 d-block mb-1">End (UTC)</label>
                        <input type="${type === 'once' ? 'datetime-local' : 'time'}" 
                               class="form-control form-control-sm mw-end bg-dark border-secondary text-light" 
                               value="${end}" onchange="syncMaintenance()">
                    </div>
                </div>
            </div>
        `;
        list.appendChild(div);
    }

    function updateMWFields(select) {
        const entry = select.closest('.maintenance-entry');
        const type = select.value;
        const daysContainer = entry.querySelector('.mw-days-container');
        const startInput = entry.querySelector('.mw-start');
        const endInput = entry.querySelector('.mw-end');

        if (type === 'once') {
            daysContainer.classList.add('d-none');
            startInput.type = 'datetime-local';
            endInput.type = 'datetime-local';
        } else {
            daysContainer.classList.toggle('d-none', type !== 'weekly');
            startInput.type = 'time';
            endInput.type = 'time';
        }
        syncMaintenance();
    }

    function syncMaintenance() {
        const windows = [];
        document.querySelectorAll('.maintenance-entry').forEach(entry => {
            const type = entry.querySelector('.mw-type').value;
            const start = entry.querySelector('.mw-start').value;
            const end = entry.querySelector('.mw-end').value;
            const days = Array.from(entry.querySelectorAll('.mw-day:checked')).map(cb => cb.value);

            if (start && end) {
                const w = { type, start, end };
                if (type === 'weekly') w.days = days;
                windows.push(w);
            }
        });
        document.getElementById('maintenance_windows').value = JSON.stringify(windows);
    }

    const templates = {
        uptime_kuma: {
            json_mapping: '{\n  "summary": "$.monitor.name",\n  "description": "$.msg",\n  "status": "$.monitor.status"\n}',
            trigger_field: 'heartbeat.status',
            open_value: '0',
            close_value: '1'
        },
        grafana: {
            json_mapping: '{\n  "summary": "$.title",\n  "description": "$.message",\n  "severity": "$.ruleName"\n}',
            trigger_field: 'state',
            open_value: 'alerting',
            close_value: 'ok'
        },
        zabbix: {
            json_mapping: '{\n  "summary": "$.event_name",\n  "description": "$.event_nseverity",\n  "priority": "$.event_severity"\n}',
            trigger_field: 'event_value',
            open_value: '1',
            close_value: '0'
        }
    };

    function applyTemplate(type) {
        if (!type || !templates[type]) return;
        const t = templates[type];
        document.getElementById('json_mapping').value = t.json_mapping;
        document.getElementById('trigger_field').value = t.trigger_field;
        document.getElementById('open_value').value = t.open_value;
        document.getElementById('close_value').value = t.close_value;
        showToast('Applied ' + type.replace('_', ' ') + ' template', 'info');
    }

    async function runDebugger() {
        const payloadText = document.getElementById('sample-json').value;
        const resultDiv = document.getElementById('debugger-result');

        if (!payloadText.trim()) {
            return showToast('Please enter a sample JSON payload', 'warning');
        }

        let payload;
        try {
            payload = JSON.parse(payloadText);
        } catch (e) {
            return showToast('Invalid JSON in sample payload', 'danger');
        }

        resultDiv.innerHTML = '<div class="text-center py-2"><span class="spinner-border spinner-border-sm text-info"></span> Simulation running...</div>';

        // Collect current form state
        const form = document.getElementById('endpoint-form');
        const formData = new FormData(form);
        const config = {};
        formData.forEach((value, key) => config[key] = value);

        try {
            const res = await fetch('/api/debug/process', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ payload, config })
            });
            const data = await res.json();

            if (data.status === 'success') {
                let html = '<div class="list-group list-group-flush bg-transparent">';
                data.steps.forEach(step => {
                    html += `<div class="list-group-item bg-transparent border-secondary border-opacity-10 text-secondary py-1 px-0">
                        <span class="text-info me-2">â†’</span> ${step}
                    </div>`;
                });
                html += '</div>';

                html += '<div class="mt-3 p-2 rounded bg-dark border border-secondary border-opacity-25">';
                html += '<div class="fw-bold text-success mb-1 small">FINAL RESULT:</div>';
                html += `<pre class="mb-0 text-white font-monospace small" style="font-size: 0.7rem;">${JSON.stringify(data.results, null, 2)}</pre>`;
                html += '</div>';

                resultDiv.innerHTML = html;
            } else {
                resultDiv.innerHTML = `<div class="alert alert-danger py-2 small">${data.message}</div>`;
            }
        } catch (e) {
            resultDiv.innerHTML = `<div class="alert alert-danger py-2 small">Error communicating with server</div>`;
        }
    }

    function formatJSON(id) {
        const el = document.getElementById(id);
        try {
            const obj = JSON.parse(el.value);
            el.value = JSON.stringify(obj, null, 2);
        } catch (e) {
            showToast('Invalid JSON in field', 'danger');
        }
    }

    function saveAsDraft() {
        document.getElementById('is_draft').value = 'true';
        document.getElementById('endpoint-form').submit();
    }

    function saveAndAnother() {
        document.getElementById('create_another').value = 'true';
        document.getElementById('endpoint-form').submit();
    }

    async function confirmDelete(id, name) {
        if (await hwConfirm(`Are you sure you want to delete "${name}"? This action cannot be undone.`, { title: 'Delete Endpoint', okText: 'Delete' })) {
            // Add a tiny delay to let the modal finish hiding before navigation
            setTimeout(() => {
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = `/endpoint/delete/${id}`;
                const csrfInput = document.createElement('input');
                csrfInput.type = 'hidden';
                csrfInput.name = 'csrf_token';
                csrfInput.value = '{{ csrf_token() }}';
                form.appendChild(csrfInput);
                document.body.appendChild(form);
                form.submit();
            }, 300);
        }
    }

    let tokenLoaded = false;
    async function toggleTokenVisibility() {
        const input = document.getElementById('bearer-token-display');
        const icon = document.getElementById('token-eye-icon');
        const configId = "{{ config.id if config else '' }}";

        if (input.type === 'password') {
            if (!tokenLoaded && configId) {
                try {
                    const res = await fetch(`/endpoint/token/${configId}`);
                    const data = await res.json();
                    if (data.token) {
                        input.value = data.token;
                        tokenLoaded = true;
                    }
                } catch (e) {
                    showToast('Failed to load token', 'danger');
                    return;
                }
            }
            input.type = 'text';
            icon.classList.replace('fa-eye', 'fa-eye-slash');
        } else {
            input.type = 'password';
            icon.classList.replace('fa-eye-slash', 'fa-eye');
        }
    }

    function copyBearerToken() {
        const input = document.getElementById('bearer-token-display');
        if (input.value === '****************' && !tokenLoaded) {
            showToast('Please reveal the token first', 'warning');
            return;
        }
        navigator.clipboard.writeText(input.value).then(() => {
            showToast('Token copied to clipboard', 'success');
        });
    }

    async function rotateBearerToken(id) {
        if (!await hwConfirm('Are you sure you want to regenerate the bearer token? Existing integrations using the old token will break immediately.', { title: 'Regenerate Token', okText: 'Regenerate' })) return;

        const btn = document.getElementById('rotate-btn');
        const input = document.getElementById('bearer-token-display');
        const originalHtml = btn.innerHTML;

        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Rotating...';

        try {
            const res = await fetch(`/endpoint/rotate-token/${id}`, {
                method: 'POST',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'Content-Type': 'application/json'
                }
            });
            const data = await res.json();

            if (data.status === 'success') {
                input.value = data.token;
                input.type = 'text';
                tokenLoaded = true;
                const icon = document.getElementById('token-eye-icon');
                if (icon) icon.classList.replace('fa-eye', 'fa-eye-slash');
                showToast('Token regenerated successfully!', 'success');
            } else {
                showToast('Rotation failed', 'danger');
            }
        } catch (e) {
            showToast('Error rotating token', 'danger');
        } finally {
            btn.disabled = false;
            btn.innerHTML = originalHtml;
        }
    }

    document.getElementById('endpoint-form').addEventListener('submit', (e) => {
        const requiredFields = ['name'];
        for (const id of requiredFields) {
            const el = document.getElementById(id);
            if (!el.value.trim()) {
                e.preventDefault();
                showToast(`${id.charAt(0).toUpperCase() + id.slice(1)} is required`, 'danger');
                el.focus();
                return;
            }
        }

        const jsonFields = ['json_mapping', 'routing_rules', 'maintenance_windows'];
        for (const id of jsonFields) {
            const val = document.getElementById(id).value.trim();
            if (val) {
                try {
                    JSON.parse(val);
                } catch (err) {
                    e.preventDefault();
                    showToast(`Invalid JSON in ${id.replace('_', ' ')}`, 'danger');
                    document.getElementById(id).focus();
                    return;
                }
            }
        }
    });

    function updatePreview() {
        const prefix = document.getElementById('ticket_prefix').value;
        const preview = document.getElementById('summary-preview');
        preview.textContent = (prefix ? prefix + ' ' : '') + 'Source Name';
    }

    htmx.onLoad(async function (elt) {
        const form = document.getElementById('endpoint-form');
        if (!form || form.dataset.initialized) return;
        form.dataset.initialized = 'true';

        form.addEventListener('input', () => {
            clearTimeout(window.saveStateTimeout);
            window.saveStateTimeout = setTimeout(saveState, 500);
        });
        saveState(); // Initial state

        document.getElementById('ticket_prefix').addEventListener('input', updatePreview);
        updatePreview();
        toggleBearerMgmt();

        const boardSelect = document.getElementById('board');
        const statusSelect = document.getElementById('status');
        const typeSelect = document.getElementById('ticket_type');
        const subtypeSelect = document.getElementById('subtype');
        const itemSelect = document.getElementById('item');
        const prioritySelect = document.getElementById('priority');

        const boardHidden = document.getElementById('board_hidden').value;
        const statusHidden = document.getElementById('status_hidden').value;
        const typeHidden = document.getElementById('type_hidden').value;
        const subtypeHidden = document.getElementById('subtype_hidden').value;
        const itemHidden = document.getElementById('item_hidden').value;
        const priorityHidden = document.getElementById('priority_hidden').value;

        const loadBoardDetails = async (boardName) => {
            if (!boardName) {
                [statusSelect, typeSelect, subtypeSelect, itemSelect].forEach(s => s.innerHTML = '<option value="">-- Select Board --</option>');
                return;
            }

            try {
                const boardsRes = await fetch('/api/cw/boards');
                const boards = await boardsRes.json();
                const board = boards.find(b => b.name === boardName);
                if (!board) return;

                const fetchAndPopulate = async (url, select, hiddenVal) => {
                    select.innerHTML = '<option value="">Loading...</option>';
                    const res = await fetch(url);
                    const items = await res.json();
                    select.innerHTML = '<option value="">-- Use Default --</option>';
                    items.forEach(i => {
                        const opt = document.createElement('option');
                        opt.value = i.name;
                        opt.textContent = i.name;
                        if (i.name === hiddenVal) opt.selected = true;
                        select.appendChild(opt);
                    });
                };

                fetchAndPopulate(`/api/cw/statuses/${board.id}`, statusSelect, statusHidden);
                fetchAndPopulate(`/api/cw/types/${board.id}`, typeSelect, typeHidden);
                fetchAndPopulate(`/api/cw/subtypes/${board.id}`, subtypeSelect, subtypeHidden);
                fetchAndPopulate(`/api/cw/items/${board.id}`, itemSelect, itemHidden);

            } catch (e) { console.error('Error loading board details', e); }
        };

        boardSelect.addEventListener('change', (e) => loadBoardDetails(e.target.value));

        // Initialize Maintenance Windows
        const mwRaw = document.getElementById('maintenance_windows').value;
        if (mwRaw) {
            try {
                const windows = JSON.parse(mwRaw);
                windows.forEach(w => addMaintenanceWindow(w));
            } catch (e) { console.error('Error parsing maintenance windows', e); }
        }

        // Fetch Boards
        try {
            const res = await fetch('/api/cw/boards');
            const boards = await res.json();
            boardSelect.innerHTML = '<option value="">-- Use Default --</option>';
            boards.forEach(b => {
                const opt = document.createElement('option');
                opt.value = b.name;
                opt.textContent = b.name;
                if (b.name === boardHidden) opt.selected = true;
                boardSelect.appendChild(opt);
            });
            if (boardHidden) loadBoardDetails(boardHidden);
        } catch (e) {
            boardSelect.innerHTML = '<option value="">Error loading boards</option>';
        }

        // Fetch Priorities
        try {
            const res = await fetch('/api/cw/priorities');
            const priorities = await res.json();
            prioritySelect.innerHTML = '<option value="">-- Use Default --</option>';
            priorities.forEach(p => {
                const opt = document.createElement('option');
                opt.value = p.name;
                opt.textContent = p.name;
                if (p.name === priorityHidden) opt.selected = true;
                prioritySelect.appendChild(opt);
            });
        } catch (e) {
            prioritySelect.innerHTML = '<option value="">Error loading priorities</option>';
        }

        // Debounce helper
        function debounce(func, wait) {
            let timeout;
            return function (...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), wait);
            };
        }

        async function fetchCompanies(query = '') {
            try {
                const url = query ? `/api/cw/companies?search=${encodeURIComponent(query)}` : '/api/cw/companies';
                const res = await fetch(url);
                const companies = await res.json();
                const datalist = document.getElementById('company_list');
                if (datalist) {
                    datalist.innerHTML = '';
                    companies.forEach(c => {
                        const opt = document.createElement('option');
                        opt.value = c.identifier;
                        opt.textContent = `${c.name} (${c.identifier})`;
                        datalist.appendChild(opt);
                    });
                }
            } catch (e) {
                console.error('Error loading companies', e);
            }
        }

        // Initial load (first 50)
        fetchCompanies();

        // Search-as-you-type listener
        const companyInput = document.getElementById('customer_id_default');
        if (companyInput) {
            companyInput.addEventListener('input', debounce((e) => {
                const val = e.target.value;
                if (val.length >= 2) {
                    fetchCompanies(val);
                } else if (val.length === 0) {
                    fetchCompanies();
                }
            }, 500));
        }
    });
</script>
{% endblock %}