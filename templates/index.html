{% extends 'base.html' %}

{% block content %}
<div class="row g-4 mb-5">
    <div class="col-md-8">
        <div class="card glass-card shadow-lg">
            <div class="card-body p-4">
                <h6 class="text-secondary text-uppercase small ls-wide mb-3">Tickets Created (Last 7 Days)</h6>
                <canvas id="historyChart" height="100"></canvas>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="row g-4">
            <div class="col-12">
                <div class="card glass-card shadow-lg">
                    <div class="card-body text-center p-3">
                        <h6 class="text-secondary text-uppercase small ls-wide mb-2">Created Today</h6>
                        <h2 class="fw-bold mb-0 text-white" id="stat-created">0</h2>
                    </div>
                </div>
            </div>
            <div class="col-12">
                <div class="card glass-card shadow-lg" style="--accent: #10b981;">
                    <div class="card-body text-center p-3">
                        <h6 class="text-secondary text-uppercase small ls-wide mb-2">Closed Today</h6>
                        <h2 class="fw-bold mb-0 text-white" id="stat-closed">0</h2>
                    </div>
                </div>
            </div>
            <div class="col-12">
                <div class="card glass-card shadow-lg" style="--accent: #f59e0b;">
                    <div class="card-body text-center p-3">
                        <h6 class="text-secondary text-uppercase small ls-wide mb-2">Success Rate</h6>
                        <h2 class="fw-bold mb-0 text-white"><span id="stat-rate">100</span>%</h2>
                    </div>
                </div>
            </div>
            <div class="col-12">
                <div class="card glass-card shadow-lg" style="--accent: #bc8cff;">
                    <div class="card-body text-center p-3">
                        <h6 class="text-secondary text-uppercase small ls-wide mb-2">Avg. Latency</h6>
                        <h2 class="fw-bold mb-0 text-white"><span id="stat-latency">0</span>s</h2>
                    </div>
                </div>
            </div>
            <div class="col-12">
                <div class="card glass-card shadow-lg" style="--accent: #ef4444;">
                    <div class="card-body text-center p-3">
                        <h6 class="text-secondary text-uppercase small ls-wide mb-2">Failed Attempts</h6>
                        <h2 class="fw-bold mb-0 text-white" id="stat-failed">0</h2>
                    </div>
                </div>
            </div>
            <div class="col-12">
                <div class="card glass-card shadow-lg" style="--accent: #6366f1;">
                    <div class="card-body p-3">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h6 class="text-secondary text-uppercase small ls-wide mb-0">Service Health</h6>
                            <button class="btn btn-sm btn-link text-secondary p-0" onclick="refreshStats()">
                                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor"
                                    class="bi bi-arrow-clockwise" viewBox="0 0 16 16">
                                    <path fill-rule="evenodd"
                                        d="M8 3a5 5 0 1 0 4.546 2.914.5.5 0 0 1 .908-.417A6 6 0 1 1 8 2v1z" />
                                    <path
                                        d="M8 4.466V.534a.25.25 0 0 1 .41-.192l2.36 1.966c.12.1.12.284 0 .384L8.41 4.658A.25.25 0 0 1 8 4.466z" />
                                </svg>
                            </button>
                        </div>
                        <div class="d-flex justify-content-around">
                            <div class="text-center">
                                <div id="dash-health-redis" class="heartbeat-dot heartbeat-warning mb-1 mx-auto"></div>
                                <div class="small text-secondary">Redis</div>
                            </div>
                            <div class="text-center">
                                <div id="dash-health-database" class="heartbeat-dot heartbeat-warning mb-1 mx-auto">
                                </div>
                                <div class="small text-secondary">DB</div>
                            </div>
                            <div class="text-center">
                                <div id="dash-health-celery" class="heartbeat-dot heartbeat-warning mb-1 mx-auto"></div>
                                <div class="small text-secondary">Celery</div>
                            </div>
                        </div>
                        <hr class="my-3 border-secondary border-opacity-10">
                        <div class="form-check form-switch d-flex justify-content-center">
                            <input class="form-check-input me-2" type="checkbox" role="switch" id="maintenance-toggle"
                                onchange="toggleMaintenance()">
                            <label class="form-check-label small text-secondary fw-bold"
                                for="maintenance-toggle">MAINTENANCE MODE</label>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="accent-gradient fw-bold mb-0">Webhook Endpoints</h1>
    {% if debug_mode %}
    <span class="badge bg-danger ms-3">DEBUG MODE ACTIVE</span>
    {% endif %}
    <div class="d-flex gap-2">
        <select id="board-filter" class="form-select form-select-sm bg-dark border-secondary text-white"
            style="width: 150px;">
            <option value="">All Boards</option>
        </select>
        <select id="status-filter" class="form-select form-select-sm bg-dark border-secondary text-white"
            style="width: 150px;">
            <option value="">All Statuses</option>
            <option value="enabled">Enabled</option>
            <option value="paused">Paused</option>
        </select>
        <div class="input-group input-group-sm" style="width: 250px;">
            <span class="input-group-text bg-dark border-secondary text-secondary">
                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" class="bi bi-search"
                    viewBox="0 0 16 16">
                    <path
                        d="M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001c.03.04.062.078.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1.007 1.007 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0z" />
                </svg>
            </span>
            <input type="text" id="endpoint-search" class="form-control bg-dark border-secondary text-white"
                placeholder="Search endpoints...">
        </div>
        <a href="{{ url_for('main.new_endpoint') }}" class="btn btn-primary d-flex align-items-center">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                class="bi bi-plus-lg me-2" viewBox="0 0 16 16">
                <path fill-rule="evenodd"
                    d="M8 2a.5.5 0 0 1 .5.5v5h5a.5.5 0 0 1 0 1h-5v5a.5.5 0 0 1-1 0v-5h-5a.5.5 0 0 1 0-1h5v-5A.5.5 0 0 1 8 2Z" />
            </svg>
            Create New
        </a>
    </div>
</div>

<div id="bulk-controls"
    class="alert alert-dark border-secondary d-none mb-4 d-flex justify-content-between align-items-center py-2">
    <span class="small text-secondary fw-bold">SELECTED ACTIONS</span>
    <div class="d-flex gap-2">
        <button class="btn btn-sm btn-outline-danger" onclick="bulkDelete()">Delete Selected</button>
        <button class="btn btn-sm btn-outline-warning" onclick="bulkPause()">Pause Selected</button>
        <button class="btn btn-sm btn-outline-success" onclick="bulkResume()">Resume Selected</button>
        <button class="btn btn-sm btn-outline-info" onclick="bulkExport()">Export Selected</button>
    </div>
</div>

{% if not configs %}
<div class="row justify-content-center py-5">
    <div class="col-md-8 text-center">
        <h3 class="text-secondary">Ready to start routing?</h3>
        <p class="lightgrey mb-5">Create your first webhook endpoint to bridge monitoring alerts to ConnectWise Manage.
        </p>

        <div class="row g-4 text-start">
            <div class="col-md-4">
                <div class="card h-100 bg-dark border-secondary border-opacity-25 shadow-sm">
                    <div class="card-body p-3">
                        <div class="h5 text-primary mb-2">1. Create</div>
                        <p class="small text-secondary mb-0">Define an endpoint name and target service board.</p>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card h-100 bg-dark border-secondary border-opacity-25 shadow-sm">
                    <div class="card-body p-3">
                        <div class="h5 text-primary mb-2">2. Configure</div>
                        <p class="small text-secondary mb-0">Copy the unique URL and Bearer Token to your alert source.
                        </p>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card h-100 bg-dark border-secondary border-opacity-25 shadow-sm">
                    <div class="card-body p-3">
                        <div class="h5 text-primary mb-2">3. Automate</div>
                        <p class="small text-secondary mb-0">Watch as HookWise creates and manages tickets for you.</p>
                    </div>
                </div>
            </div>
        </div>

        <a href="{{ url_for('main.new_endpoint') }}" class="btn btn-primary btn-lg mt-5 px-5">Create First Endpoint</a>
    </div>
</div>
{% else %}
<div id="endpoint-skeleton" class="row d-none">
    {% for i in range(4) %}
    <div class="col-md-6 mb-4">
        <div class="card h-100 skeleton-card skeleton" style="height: 250px;"></div>
    </div>
    {% endfor %}
</div>

<div class="row mb-5">
    <div class="col-12">
        <div class="card glass-card shadow-lg border-0 overflow-hidden terminal-window">
            <div
                class="card-header bg-transparent border-bottom border-light border-opacity-10 d-flex justify-content-between align-items-center py-2 px-3">
                <div class="d-flex gap-2">
                    <div class="terminal-dot bg-danger"></div>
                    <div class="terminal-dot bg-warning"></div>
                    <div class="terminal-dot bg-success"></div>
                </div>
                <div class="text-secondary small fw-bold" style="font-size: 0.65rem; letter-spacing: 0.1em;">LIVE
                    ACTIVITY STREAM</div>
                <button class="btn btn-sm btn-link p-0 text-secondary" onclick="clearLog()" data-tooltip="Clear Stream">
                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor"
                        class="bi bi-trash-fill" viewBox="0 0 16 16">
                        <path
                            d="M2.5 1a1 1 0 0 0-1 1v1a1 1 0 0 0 1 1H3v9a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2V4h.5a1 1 0 0 0 1-1V2a1 1 0 0 0-1-1H10a1 1 0 0 0-1-1H7a1 1 0 0 0-1 1H2.5zm3 4a.5.5 0 0 1 .5.5v7a.5.5 0 0 1-1 0v-7a.5.5 0 0 1 .5-.5zM8 5a.5.5 0 0 1 .5.5v7a.5.5 0 0 1-1 0v-7A.5.5 0 0 1 8 5zm3 .5v7a.5.5 0 0 1-1 0v-7a.5.5 0 0 1 1 0z" />
                    </svg>
                </button>
            </div>
            <div class="card-body p-0">
                <div id="log-container" class="bg-transparent text-white font-monospace p-3"
                    style="height: 250px; overflow-y: auto; font-size: 0.8rem; scrollbar-width: thin; scrollbar-color: var(--border) transparent;">
                    <div class="text-secondary opacity-50 italic">Initializing secure socket connection...</div>
                </div>
            </div>
        </div>
    </div>
</div>
</div>

<div class="mb-3 d-flex justify-content-between align-items-center">
    <div class="form-check">
        <input class="form-check-input" type="checkbox" id="check-all">
        <label class="form-check-label small text-secondary fw-bold" for="check-all">SELECT ALL</label>
    </div>
    <div class="btn-group btn-group-sm">
        <button class="btn btn-outline-secondary active" onclick="toggleView('grid')">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-grid-fill"
                viewBox="0 0 16 16">
                <path
                    d="M1 2.5A1.5 1.5 0 0 1 2.5 1h3A1.5 1.5 0 0 1 7 2.5v3A1.5 1.5 0 0 1 5.5 7h-3A1.5 1.5 0 0 1 1 5.5v-3zM9 2.5A1.5 1.5 0 0 1 10.5 1h3A1.5 1.5 0 0 1 15 2.5v3A1.5 1.5 0 0 1 13.5 7h-3A1.5 1.5 0 0 1 9 5.5v-3zM1 10.5A1.5 1.5 0 0 1 2.5 9h3A1.5 1.5 0 0 1 7 10.5v3A1.5 1.5 0 0 1 5.5 15h-3A1.5 1.5 0 0 1 1 13.5v-3zM9 10.5A1.5 1.5 0 0 1 10.5 9h3a1.5 1.5 0 0 1 1.5 1.5v3a1.5 1.5 0 0 1-1.5 1.5h-3A1.5 1.5 0 0 1 9 13.5v-3z" />
            </svg>
        </button>
        <button class="btn btn-outline-secondary" onclick="toggleView('list')">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-list-task"
                viewBox="0 0 16 16">
                <path fill-rule="evenodd"
                    d="M2 2.5a.5.5 0 0 0-.5.5v1a.5.5 0 0 0 .5.5h1a.5.5 0 0 0 .5-.5V3a.5.5 0 0 0-.5-.5H2zM3 12a1 1 0 1 0 0-2 1 1 0 0 0 0 2zm0-3a1 1 0 1 0 0-2 1 1 0 0 0 0 2zm0-3a1 1 0 1 0 0-2 1 1 0 0 0 0 2zm9 7a1 1 0 1 0 0-2 1 1 0 0 0 0 2zm0-3a1 1 0 1 0 0-2 1 1 0 0 0 0 2zm0-3a1 1 0 1 0 0-2 1 1 0 0 0 0 2zM9.172 3.03a.5.5 0 0 1 .664-.058l.1.058l2 2a.5.5 0 1 1-.708.707L10 4.414V11a.5.5 0 0 1-1 0V4.414L7.854 5.51a.5.5 0 0 1-.708-.707l2-2z" />
            </svg>
        </button>
    </div>
</div>

<div class="row" id="endpoint-grid">
    {% for config in configs %}
    <div class="col-xl-6 col-lg-12 mb-4 draggable-card" draggable="true" data-id="{{ config.id }}">
        <div class="card h-100 endpoint-card glass-card shadow-lg" data-name="{{ config.name }}"
            data-id="{{ config.id }}" data-board="{{ config.board or 'Default' }}"
            data-status="{{ 'enabled' if config.is_enabled else 'paused' }}">
            <div class="paused-badge">PAUSED</div>
            <div class="card-body p-4">
                <!-- Action Toolbar Overlay -->
                <div class="endpoint-actions">
                    <button onclick="togglePin('{{ config.id }}')"
                        class="btn btn-sm btn-link p-0 text-{{ 'warning' if config.is_pinned else 'secondary' }} hover-warning"
                        data-tooltip="{{ 'Unpin' if config.is_pinned else 'Pin' }}">
                        {% if config.is_pinned %}<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16"
                            fill="currentColor" class="bi bi-pin-fill" viewBox="0 0 16 16">
                            <path
                                d="M4.146.146A.5.5 0 0 1 4.5 0h7a.5.5 0 0 1 .5.5c0 .68-.342 1.174-.646 1.479-.126.125-.25.224-.354.298v4.431l.078.048c.203.127.476.314.751.555C12.36 7.775 13 8.527 13 9.5a.5.5 0 0 1-.5.5h-4v4.5c0 .276-.224.5-.5.5s-.5-.224-.5-.5V10h-4a.5.5 0 0 1-.5-.5c0-.973.64-1.725 1.17-2.189A5.921 5.921 0 0 1 5 6.708V2.277a2.77 2.77 0 0 1-.354-.298C4.342 1.674 4 1.179 4 .5a.5.5 0 0 1 .146-.354z" />
                        </svg>{% else %}<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16"
                            fill="currentColor" class="bi bi-pin" viewBox="0 0 16 16">
                            <path
                                d="M4.146.146A.5.5 0 0 1 4.5 0h7a.5.5 0 0 1 .5.5c0 .68-.342 1.174-.646 1.479-.126.125-.25.224-.354.298v4.431l.078.048c.203.127.476.314.751.555C12.36 7.775 13 8.527 13 9.5a.5.5 0 0 1-.5.5h-4v4.5c0 .276-.224.5-.5.5s-.5-.224-.5-.5V10h-4a.5.5 0 0 1-.5-.5c0-.973.64-1.725 1.17-2.189A5.921 5.921 0 0 1 5 6.708V2.277a2.77 2.77 0 0 1-.354-.298C4.342 1.674 4 1.179 4 .5a.5.5 0 0 1 .146-.354zm1.58 1.408-.002-.001.002.001zm-.002-.001.002.001A.5.5 0 0 1 6 2v5a.5.5 0 0 1-.276.447L5.048 8H10.952l-.676-.353A.5.5 0 0 1 10 7V2a.5.5 0 0 1 .146-.354c.14-.14.343-.311.55-.515C10.983 1.112 11.246 1 11.5 1h-7c.254 0 .517.112.804.401.207.204.41.375.55.515z" />
                        </svg>{% endif %}
                    </button>
                    <button onclick="toggleEndpoint('{{ config.id }}')"
                        class="btn btn-sm btn-link p-0 text-secondary hover-{{ 'success' if not config.is_enabled else 'warning' }}"
                        data-tooltip="{{ 'Resume' if not config.is_enabled else 'Pause' }}">
                        {% if config.is_enabled %}<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16"
                            fill="currentColor" class="bi bi-pause-circle" viewBox="0 0 16 16">
                            <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z" />
                            <path
                                d="M5 6.25a1.25 1.25 0 1 1 2.5 0v3.5a1.25 1.25 0 1 1-2.5 0v-3.5zm3.5 0a1.25 1.25 0 1 1 2.5 0v3.5a1.25 1.25 0 1 1-2.5 0v-3.5z" />
                        </svg>{% else %}<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16"
                            fill="currentColor" class="bi bi-play-circle" viewBox="0 0 16 16">
                            <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z" />
                            <path
                                d="M6.271 5.055a.5.5 0 0 1 .52.038l3.5 2.5a.5.5 0 0 1 0 .814l-3.5 2.5A.5.5 0 0 1 6 10.5v-5a.5.5 0 0 1 .271-.445z" />
                        </svg>{% endif %}
                    </button>
                    <button onclick="testEndpoint('{{ config.id }}')"
                        class="btn btn-sm btn-link p-0 text-secondary hover-info" data-tooltip="Test Webhook">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                            class="bi bi-play-fill" viewBox="0 0 16 16">
                            <path
                                d="m11.596 8.697-6.363 3.692c-.54.313-1.233-.066-1.233-.697V4.308c0-.63.692-1.01 1.233-.696l6.363 3.692a.802.802 0 0 1 0 1.393z" />
                        </svg>
                    </button>
                    <a href="{{ url_for('main.edit_endpoint', id=config.id) }}"
                        class="btn btn-sm btn-link p-0 text-secondary hover-primary" data-tooltip="Settings">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                            class="bi bi-gear-fill" viewBox="0 0 16 16">
                            <path
                                d="M9.405 1.05c-.413-1.4-2.397-1.4-2.81 0l-.1.34a1.464 1.464 0 0 1-2.105.872l-.31-.17c-1.283-.698-2.686.705-1.987 1.987l.169.311c.446.82.023 1.841-.872 2.105l-.34.1c-1.4.413-1.4 2.397 0 2.81l.34.1a1.464 1.464 0 0 1 .872 2.105l-.17.31c-.698 1.283.705 2.686 1.987 1.987l.311-.169a1.464 1.464 0 0 1 2.105.872l.1.34c.413 1.4 2.397 1.4 2.81 0l.1-.34a1.464 1.464 0 0 1 2.105-.872l.31.17c1.283.698 2.686-.705 1.987-1.987l-.169-.311a1.464 1.464 0 0 1 .872-2.105l.34-.1c1.4-.413 1.4-2.397 0-2.81l-.34-.1a1.464 1.464 0 0 1-.872-2.105l.17-.31c.698-1.283-.705-2.686-1.987-1.987l-.311.169a1.464 1.464 0 0 1-2.105-.872l-.1-.34zM8 10.93a2.929 2.929 0 1 1 0-5.86 2.929 2.929 0 0 1 0 5.858z" />
                        </svg>
                    </a>
                </div>

                <!-- Header: Name & Sparkline -->
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <div class="d-flex align-items-center">
                        <input type="checkbox" class="endpoint-check form-check-input me-3" data-id="{{ config.id }}">
                        <div>
                            <h4 class="mb-1 text-white fw-bold">{{ config.name }}</h4>
                            <div class="d-flex gap-2">
                                <span
                                    class="heartbeat-dot {{ 'pulse-success' if config.is_enabled else '' }} {{ 'status-paused' if not config.is_enabled else 'status-processed' if last_statuses.get(config.id) == 'processed' else 'status-failed' if last_statuses.get(config.id) == 'failed' else 'status-skipped' if last_statuses.get(config.id) == 'skipped' else 'status-default' }}"></span>

                                <small class="text-secondary opacity-75 font-monospace" style="font-size: 0.65rem;">UID:
                                    {{ config.id[:16] }}</small>
                            </div>
                        </div>
                    </div>
                    <canvas id="sparkline-{{ config.id }}" width="100" height="40"
                        data-sparkline='{{ sparklines.get(config.id, [0, 0, 0, 0, 0, 0, 0]) | tojson }}'></canvas>
                </div>

                <!-- Security HUD Trigger -->
                <div class="position-absolute top-0 start-0 p-3">
                    <button
                        class="btn btn-sm btn-link p-0 text-{{ 'success' if config.config_health_status == 'OK' else 'danger' if config.config_health_status == 'ERROR' else 'warning' }} opacity-50 hover-opacity-100"
                        data-id="{{ config.id }}" data-status="{{ config.config_health_status }}"
                        data-message="{{ config.config_health_message or '' }}" data-ip="{{ config.last_ip or '' }}"
                        data-rotated="{{ config.last_rotated_at or '' }}"
                        onclick="showSecurityHud(this.dataset.id, this.dataset.status, this.dataset.message, this.dataset.ip, this.dataset.rotated)"
                        data-tooltip="Security & Health: {{ config.config_health_status }}">
                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor"
                            class="bi bi-shield-check" viewBox="0 0 16 16">
                            <path
                                d="M5.338 1.59a61.44 61.44 0 0 0-2.837.856.481.481 0 0 0-.328.39c-.554 4.157.726 7.19 2.253 9.188a10.725 10.725 0 0 0 2.287 2.233c.346.244.652.42.893.533.12.057.218.095.293.118a.55.55 0 0 0 .101.025.615.615 0 0 0 .1-.025c.076-.023.174-.061.294-.118.24-.113.547-.29.893-.533a10.726 10.726 0 0 0 2.287-2.233c1.527-1.997 2.807-5.031 2.253-9.188a.48.48 0 0 0-.328-.39c-.651-.213-1.75-.56-2.837-.855C9.552 1.29 8.531 1.067 8 1.067c-.53 0-1.552.223-2.662.524zM5.072.56C6.157.265 7.31 0 8 0s1.843.265 2.928.56c1.11.3 2.229.655 2.887.87a1.54 1.54 0 0 1 1.044 1.262c.596 4.477-.787 7.795-2.465 9.99a11.775 11.775 0 0 1-2.517 2.453 7.159 7.159 0 0 1-1.048.625c-.28.132-.581.24-.829.24s-.548-.108-.829-.24a7.158 7.158 0 0 1-1.048-.625 11.777 11.777 0 0 1-2.517-2.453C1.928 10.487.545 7.169 1.141 2.692A1.54 1.54 0 0 1 2.185 1.43 62.456 62.456 0 0 1 5.072.56z" />
                        </svg>
                    </button>
                </div>

                <!-- Technical Fields -->
                <div class="mb-3">
                    <div class="tech-label">Endpoint URL</div>
                    <div class="copyable-field">
                        <code class="user-select-all text-truncate flex-grow-1">{{ base_url }}/w/{{ config.id }}</code>
                        <button class="btn btn-sm btn-link text-primary p-0"
                            onclick="copyToClipboard('{{ base_url }}/w/{{ config.id }}')" data-tooltip="Copy URL">
                            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor"
                                class="bi bi-clipboard" viewBox="0 0 16 16">
                                <path
                                    d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1h1a1 1 0 0 1 1 1V14a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V3.5a1 1 0 0 1 1-1h1v-1z" />
                                <path
                                    d="M9.5 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3zm-3-1A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3z" />
                            </svg>
                        </button>
                    </div>
                </div>

                <!-- Simplified Activity Stats -->
                <div class="tech-grid mb-4">
                    <div class="tech-item">
                        <div class="tech-label text-success">SUCCESS</div>
                        <div class="h5 mb-0 fw-bold">{{ counts.get(config.id, {}).get('processed', 0) }}</div>
                        <div class="small text-secondary opacity-50 text-uppercase ls-1" style="font-size: 0.5rem;">
                            Total 24H</div>
                    </div>
                    <div class="tech-item">
                        <div class="tech-label text-danger">FAILED</div>
                        <div class="h5 mb-0 fw-bold">{{ counts.get(config.id, {}).get('failed', 0) }}</div>
                        <div class="small text-secondary opacity-50 text-uppercase ls-1" style="font-size: 0.5rem;">
                            Recent</div>
                    </div>
                    <div class="tech-item">
                        <div class="tech-label text-warning">SKIPPED</div>
                        <div class="h5 mb-0 fw-bold">{{ counts.get(config.id, {}).get('skipped', 0) }}</div>
                        <div class="small text-secondary opacity-50 text-uppercase ls-1" style="font-size: 0.5rem;">
                            Dedupe</div>
                    </div>
                    <div class="tech-item">
                        <div class="tech-label text-primary">LAST SEEN</div>
                        <div class="small mb-1 fw-bold text-white text-truncate" style="font-size: 0.7rem;">
                            {{ config.last_seen_at.strftime('%H:%M %m/%d') if config.last_seen_at else 'NEVER' }}
                        </div>
                        <div class="small text-secondary opacity-50 text-uppercase ls-1" style="font-size: 0.5rem;">UTC
                            Time</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endfor %}
</div>
{% endif %}

<!-- Payload Modal -->
<div class="modal fade" id="payloadModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content bg-dark border-secondary">
            <div class="modal-header border-secondary">
                <h5 class="modal-title">Webhook Payload</h5>
                <div class="ms-auto me-2">
                    <button id="pretty-toggle" class="btn btn-sm btn-outline-info me-2">Minified</button>
                    <button class="btn btn-sm btn-outline-primary" onclick="copyModalPayload()">Copy JSON</button>
                </div>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <pre
                    class="bg-black p-0 rounded"><code id="payload-display" class="language-json" style="font-size: 0.85rem; max-height: 500px; overflow: auto; display: block;"></code></pre>
            </div>
        </div>
    </div>
</div>

<!-- Rotate Token Modal -->
<div class="modal fade" id="rotateModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content bg-dark border-warning">
            <div class="modal-header border-warning border-opacity-25">
                <h5 class="modal-title text-warning">Rotate Bearer Token</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to rotate the token for <strong id="rotate-endpoint-name"></strong>?</p>
                <p class="text-danger small"><strong>Warning:</strong> Any source currently using the old token will
                    immediately fail until updated.</p>
            </div>
            <div class="modal-footer border-warning border-opacity-25">
                <button type="button" class="btn btn-sm btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                <form id="rotate-form" method="POST">
                    <button type="submit" class="btn btn-sm btn-warning text-dark fw-bold">Rotate Token</button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Context Menu -->
<div id="context-menu" class="dropdown-menu shadow-lg border border-secondary border-opacity-25"
    style="display: none; position: absolute; z-index: 10000; min-width: 180px;">
    <a class="dropdown-item d-flex align-items-center" href="#" id="ctx-edit">
        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor"
            class="bi bi-pencil-square me-2" viewBox="0 0 16 16">
            <path
                d="M15.502 1.94a.5.5 0 0 1 0 .706L14.459 3.69l-2-2L13.502.646a.5.5 0 0 1 .707 0l1.293 1.293zm-1.75 2.456-2-2L4.939 9.21a.5.5 0 0 0-.121.196l-.805 2.414a.25.25 0 0 0 .316.316l2.414-.805a.5.5 0 0 0 .196-.12l6.813-6.814z" />
            <path fill-rule="evenodd"
                d="M1 13.5A1.5 1.5 0 0 0 2.5 15h11a1.5 1.5 0 0 0 1.5-1.5v-6a.5.5 0 0 0-1 0v6a.5.5 0 0 1-.5.5h-11a.5.5 0 0 1-.5-.5v-11a.5.5 0 0 1 .5-.5H9a.5.5 0 0 0 0-1H2.5A1.5 1.5 0 0 0 1 2.5v11z" />
        </svg>
        Edit Endpoint
    </a>
    <a class="dropdown-item d-flex align-items-center" href="#" id="ctx-test">
        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" class="bi bi-play-fill me-2"
            viewBox="0 0 16 16">
            <path
                d="m11.596 8.697-6.363 3.692c-.54.313-1.233-.066-1.233-.697V4.308c0-.63.692-1.01 1.233-.696l6.363 3.692a.802.802 0 0 1 0 1.393z" />
        </svg>
        Test Webhook
    </a>
    <a class="dropdown-item d-flex align-items-center" href="#" id="ctx-clone">
        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" class="bi bi-copy me-2"
            viewBox="0 0 16 16">
            <path fill-rule="evenodd"
                d="M4 2a2 2 0 0 1 2-2h8a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V2Zm2-1a1 1 0 0 0-1 1v8a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1V2a1 1 0 0 0-1-1H6Z" />
            <path
                d="M2 5a1 1 0 0 0-1 1v8a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1v-1h1v1a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h1v1H2Z" />
        </svg>
        Clone Configuration
    </a>
    <div class="dropdown-divider border-secondary border-opacity-10"></div>
    <a class="dropdown-item d-flex align-items-center text-danger" href="#" id="ctx-delete">
        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor"
            class="bi bi-trash3-fill me-2" viewBox="0 0 16 16">
            <path
                d="M11 1.5v1h3.5a.5.5 0 0 1 0 1h-.538l-.853 10.66A2 2 0 0 1 11.115 16h-6.23a2 2 0 0 1-1.994-1.84L2.038 3.5H1.5a.5.5 0 0 1 0-1H5v-1A1.5 1.5 0 0 1 6.5 0h3A1.5 1.5 0 0 1 11 1.5Zm-5 0v1h4v-1a.5.5 0 0 0-.5-.5h-3a.5.5 0 0 0-.5.5ZM4.5 5.029l.5 8.5a.5.5 0 1 0 .998-.06l-.5-8.5a.5.5 0 1 0-.998.06Zm6.53-.06a.5.5 0 0 0-.598.374l-1.5 8.5a.5.5 0 1 0 .98.173l1.5-8.5a.5.5 0 0 0-.382-.547ZM6.274 5.05a.5.5 0 0 0-.516.474l-.5 8.5a.5.5 0 1 0 .998.06l.5-8.5a.5.5 0 0 0-.482-.534Z" />
        </svg>
        Delete Endpoint
    </a>
</div>

<!-- Onboarding Modal -->
<div class="modal fade" id="onboardingModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content bg-dark border-primary">
            <div class="modal-header border-primary border-opacity-25">
                <h5 class="modal-title text-primary">Welcome to HookWise!</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center py-5">
                <img src="{{ url_for('static', filename='img/logo.png') }}" alt="HookWise" height="80" class="mb-4">
                <h3 class="fw-bold">Let's get you set up.</h3>
                <p class="text-secondary mb-5">HookWise bridges your monitoring tools to ConnectWise Manage tickets.</p>

                <div class="row g-4 text-start">
                    <div class="col-md-4">
                        <div class="card h-100 bg-black bg-opacity-25 border-0">
                            <div class="card-body">
                                <div class="h6 text-info">1. API Keys</div>
                                <p class="small lightgrey">Ensure your ConnectWise API keys are set in your
                                    <code>.env</code> file.
                                </p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card h-100 bg-black bg-opacity-25 border-0">
                            <div class="card-body">
                                <div class="h6 text-info">2. Endpoint</div>
                                <p class="small lightgrey">Create an endpoint for each tool (e.g. Uptime Kuma,
                                    Grafana).</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card h-100 bg-black bg-opacity-25 border-0">
                            <div class="card-body">
                                <div class="h6 text-info">3. Webhooks</div>
                                <p class="small lightgrey">Copy your endpoint URL to your monitoring tool's webhook
                                    settings.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer border-primary border-opacity-25">
                <button type="button" class="btn btn-primary px-5" data-bs-dismiss="modal">I'm ready!</button>
            </div>
        </div>
    </div>
</div>

<!-- Security HUD Modal -->
<div class="modal fade" id="securityHudModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content glass-card border-0">
            <div class="modal-header border-bottom border-light border-opacity-10">
                <h5 class="modal-title text-white"><i class="fas fa-shield-alt me-2 text-info"></i>Security & Health
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="text-center mb-4">
                    <div id="hud-status-icon" class="display-4 mb-2"></div>
                    <h4 id="hud-status-text" class="fw-bold"></h4>
                    <p id="hud-message" class="text-secondary small"></p>
                </div>

                <div class="bg-black bg-opacity-25 rounded p-3 mb-3">
                    <div class="d-flex justify-content-between mb-2">
                        <span class="text-secondary small">Last IP Address</span>
                        <span id="hud-last-ip" class="font-monospace text-info small"></span>
                    </div>
                    <div class="d-flex justify-content-between">
                        <span class="text-secondary small">Token Age</span>
                        <span id="hud-token-age" class="font-monospace text-warning small"></span>
                    </div>
                </div>

                <div class="d-grid">
                    <button class="btn btn-outline-light btn-sm" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
    async function quickUpdate(id, field, value) {
        const select = event.target;
        if (value === 'LOAD') {
            select.innerHTML = '<option value="">Loading...</option>';
            try {
                let endpoint = '';
                if (field === 'board') endpoint = '/api/cw/boards';
                else if (field === 'priority') endpoint = '/api/cw/priorities';
                else if (field === 'status') {
                    const card = select.closest('.endpoint-card');
                    const boardName = card.dataset.board;
                    const boardsRes = await fetch('/api/cw/boards');
                    const boards = await boardsRes.json();
                    const board = boards.find(b => b.name === boardName);
                    if (board) endpoint = `/api/cw/statuses/${board.id}`;
                }

                if (!endpoint) throw new Error('Could not determine endpoint');

                const res = await fetch(endpoint);
                const items = await res.json();
                select.innerHTML = '<option value="">-- Default --</option>';
                items.forEach(item => {
                    const opt = document.createElement('option');
                    opt.value = item.name;
                    opt.textContent = item.name;
                    select.appendChild(opt);
                });
            } catch (e) {
                showToast('Error loading ' + field + 's', 'danger');
            }
            return;
        }

        try {
            const res = await fetch(`/endpoint/quick-update/${id}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ field, value })
            });
            const data = await res.json();
            if (data.status === 'success') {
                showToast(field.charAt(0).toUpperCase() + field.slice(1) + ' updated', 'success');
                if (field === 'board') {
                    select.closest('.endpoint-card').dataset.board = value;
                }
            } else {
                showToast('Error: ' + data.message, 'danger');
            }
        } catch (e) {
            showToast('Connection error', 'danger');
        }
    }

    function confirmRotate(id, name) {
        document.getElementById('rotate-endpoint-name').textContent = name;
        document.getElementById('rotate-form').action = `/endpoint/rotate-token/${id}`;
        new bootstrap.Modal(document.getElementById('rotateModal')).show();
    }

    // Live Dashboard Logic (Refined)
    var isPaused = typeof isPaused !== 'undefined' ? isPaused : false;
    var absoluteTime = typeof absoluteTime !== 'undefined' ? absoluteTime : false;
    var currentDashboardPayload = typeof currentDashboardPayload !== 'undefined' ? currentDashboardPayload : null;
    var isDashboardPretty = typeof isDashboardPretty !== 'undefined' ? isDashboardPretty : true;

    function updateDashboardPayloadDisplay() {
        const display = document.getElementById('payload-display');
        const toggleBtn = document.getElementById('pretty-toggle');
        if (isDashboardPretty) {
            display.textContent = JSON.stringify(currentDashboardPayload, null, 2);
            toggleBtn.textContent = 'Minified';
        } else {
            display.textContent = JSON.stringify(currentDashboardPayload);
            toggleBtn.textContent = 'Pretty';
        }
        Prism.highlightElement(display);
    }

    document.getElementById('pretty-toggle').addEventListener('click', () => {
        isDashboardPretty = !isDashboardPretty;
        updateDashboardPayloadDisplay();
    });

    document.addEventListener('DOMContentLoaded', function () {
        const socket = getSocket();
        if (socket) {
            socket.off('connect');
            socket.off('new_log');
        }

        const logContainer = document.getElementById('log-container');
        if (!logContainer || logContainer.dataset.initialized) return;
        logContainer.dataset.initialized = 'true';

        const pauseBtn = document.getElementById('pause-button');
        const timeBtn = document.getElementById('time-toggle');
        const clearBtn = document.getElementById('clear-logs');
        const fullscreenBtn = document.getElementById('fullscreen-button');
        const logFilter = document.getElementById('log-filter');

        if (fullscreenBtn) {
            fullscreenBtn.addEventListener('click', () => {
                const logCard = logContainer.closest('.card');
                if (!document.fullscreenElement) {
                    logCard.requestFullscreen().catch(err => {
                        showToast(`Error attempting to enable full-screen mode: ${err.message}`, 'danger');
                    });
                } else {
                    document.exitFullscreen();
                }
            });
        }

        if (clearBtn) {
            clearBtn.addEventListener('click', () => {
                logContainer.innerHTML = '<div class="lightgrey opacity-50 italic">Waiting for activity...</div>';
            });
        }

        if (pauseBtn) {
            pauseBtn.addEventListener('click', () => {
                isPaused = !isPaused;
                pauseBtn.classList.toggle('btn-primary', isPaused);
                pauseBtn.classList.toggle('btn-outline-secondary', !isPaused);
            });
        }

        if (timeBtn) {
            timeBtn.addEventListener('click', () => {
                absoluteTime = !absoluteTime;
                timeBtn.classList.toggle('btn-primary', absoluteTime);
                timeBtn.classList.toggle('btn-outline-secondary', !absoluteTime);
                // Refresh visible logs to update time format
                logContainer.querySelectorAll('.log-entry').forEach(entry => {
                    const ts = entry.dataset.timestamp;
                    if (ts) {
                        const timeSpan = entry.querySelector('.text-secondary');
                        if (timeSpan) {
                            const date = new Date(ts);
                            timeSpan.textContent = absoluteTime ? `[${date.toLocaleTimeString()}]` : `[${getRelativeTime(date)}]`;
                        }
                    }
                });
            });
        }

        if (socket) {
            socket.on('connect', () => {
                const statusBadge = document.getElementById('socket-status');
                if (statusBadge) {
                    statusBadge.textContent = 'Live';
                    statusBadge.className = 'badge bg-success';
                }
            });
        }

        socket.on('new_log', (data) => {
            if (isPaused) return;

            if (logContainer.querySelector('.lightgrey')) {
                logContainer.innerHTML = '';
            }

            const logEntry = document.createElement('div');
            // Advanced Flow View Logic
            const isError = data.level === 'warning' || data.level === 'error';
            const statusColor = isError ? 'danger' : 'success';

            // Flow Steps
            // 1. Ingest (always success if we are here)
            // 2. Auth (assumed success if processed)
            // 3. Mapping (Rule matched?)
            // 4. ConnectWise (Ticket created?)

            const timeStr = new Date(data.timestamp).toLocaleTimeString();

            let flowHtml = `
                <div class="d-flex align-items-center gap-2 small">
                    <span class="text-secondary font-monospace" style="font-size: 0.7rem;">${timeStr}</span>
                    <span class="fw-bold text-light">${escapeHtml(data.config_name)}</span>
                    
                    <!-- Flow Icons -->
                    <div class="d-flex align-items-center bg-dark bg-opacity-50 rounded px-2 py-1 ms-2 border border-secondary border-opacity-10">
                        <!-- Step 1: Ingest -->
                        <span class="text-success" title="Payload Received"><i class="fas fa-satellite-dish"></i></span>
                        <span class="text-secondary mx-1 opacity-25">&rarr;</span>
                        
                        <!-- Step 2: Processing -->
                        <span class="text-${statusColor}" title="${escapeHtml(data.message)}">
                            <i class="fas fa-cog ${isError ? 'fa-spin text-danger' : ''}"></i>
                        </span>
                        
                        <!-- Step 3: Action -->
                         <span class="text-secondary mx-1 opacity-25">&rarr;</span>
                        <span class="text-${data.ticket_id ? 'primary' : 'secondary'}" title="${data.ticket_id ? 'Ticket Created' : 'No Action'}">
                            <i class="fas fa-ticket-alt"></i>
                        </span>
                    </div>

                     <span class="text-${statusColor} ms-2 text-truncate" style="max-width: 300px;">
                        ${escapeHtml(data.message)}
                    </span>
                    
                    ${data.ticket_id ? `<a href="{{ cw_url }}/service/tickets/${data.ticket_id}" target="_blank" class="badge bg-primary text-decoration-none ms-auto">#${data.ticket_id}</a>` : ''}
                    
                    <button class="btn btn-sm btn-link text-secondary ms-auto p-0" onclick="showPayloadModal('${escapeHtml(JSON.stringify(data.payload))}')">
                        <i class="fas fa-expand"></i>
                    </button>
                </div>
            `;

            logEntry.className = `log-entry mb-1 p-2 border-bottom border-light border-opacity-5 hover-bg-light`;
            logEntry.innerHTML = flowHtml;

            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;

            if (window.notifyFailure && isError) window.notifyFailure(data);

            while (logContainer.childNodes.length > 200) {
                logContainer.removeChild(logContainer.firstChild);
            }
        });

        // Log Filter Logic
        if (logFilter) {
            logFilter.addEventListener('input', (e) => {
                const term = e.target.value.toLowerCase();
                logContainer.querySelectorAll('.log-entry').forEach(entry => {
                    entry.style.display = entry.innerText.toLowerCase().includes(term) ? 'block' : 'none';
                });
            });
        }
    });

    function copyModalPayload() {
        const text = document.getElementById('payload-display').textContent;
        navigator.clipboard.writeText(text);
        showToast('Payload copied to clipboard!', 'success');
    }

    function testEndpoint(id) {
        fetch(`/endpoint/test/${id}`, { method: 'POST' })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    showToast('Test webhook queued!', 'success');
                } else {
                    showToast('Error: ' + data.message, 'danger');
                }
            })
            .catch(error => {
                showToast('Connection error', 'danger');
            });
    }

    function refreshStats() {
        fetch('/api/stats')
            .then(res => res.json())
            .then(data => {
                document.getElementById('stat-created').textContent = data.created_today;
                document.getElementById('stat-closed').textContent = data.closed_today;
                document.getElementById('stat-rate').textContent = data.success_rate;
                document.getElementById('stat-failed').textContent = data.failed_today;
                document.getElementById('stat-latency').textContent = data.avg_processing_time;
            })
            .catch(err => console.error('Error fetching stats:', err));

        fetch('/api/stats/history')
            .then(res => res.json())
            .then(data => {
                const labels = data.map(d => d.date);
                const counts = data.map(d => d.count);
                MiniChart.renderBar('historyChart', labels, counts);

                // Simple highlight logic
                document.getElementById('historyChart').onclick = () => {
                    showToast('Activity trend updated from live logs.', 'info');
                };
            });
    }

    async function toggleMaintenance() {
        try {
            const res = await fetch('/admin/maintenance', { method: 'POST' });
            const data = await res.json();
            showToast('Maintenance mode ' + (data.maintenance_mode ? 'ENABLED' : 'DISABLED'), data.maintenance_mode ? 'warning' : 'success');
        } catch (e) {
            showToast('Error toggling maintenance mode', 'danger');
        }
    }

    function showPayloadModal(payloadStr) {
        try {
            // Handle potential double-encoding or already object
            let payload = typeof payloadStr === 'string' ? JSON.parse(payloadStr) : payloadStr;
            currentDashboardPayload = payload;
            isDashboardPretty = true;
            updateDashboardPayloadDisplay();
            new bootstrap.Modal(document.getElementById('payloadModal')).show();
        } catch (e) {
            console.error("Payload parse error", e);
            showToast('Error displaying payload', 'danger');
        }
    }

    function showSecurityHud(id, status, message, lastIp, rotatedAt) {
        const modal = new bootstrap.Modal(document.getElementById('securityHudModal'));
        const icon = document.getElementById('hud-status-icon');
        const text = document.getElementById('hud-status-text');
        const msg = document.getElementById('hud-message');
        const ip = document.getElementById('hud-last-ip');
        const age = document.getElementById('hud-token-age');

        // Status Logic
        if (status === 'OK') {
            icon.innerHTML = '<i class="fas fa-check-circle text-success"></i>';
            text.className = 'fw-bold text-success';
            text.textContent = 'System Healthy';
        } else if (status === 'ERROR') {
            icon.innerHTML = '<i class="fas fa-exclamation-triangle text-danger"></i>';
            text.className = 'fw-bold text-danger';
            text.textContent = 'Security Alert';
        } else {
            icon.innerHTML = '<i class="fas fa-info-circle text-warning"></i>';
            text.className = 'fw-bold text-warning';
            text.textContent = 'Warning';
        }

        msg.textContent = message || 'No active security notifications.';
        ip.textContent = lastIp || 'Unknown';

        if (rotatedAt && rotatedAt !== 'None') {
            const rotatedDate = new Date(rotatedAt);
            const days = Math.floor((new Date() - rotatedDate) / (1000 * 60 * 60 * 24));
            age.textContent = `${days} days ago`;
        } else {
            age.textContent = 'Never rotated';
        }

        modal.show();
    }

    // Unified initialization for first-load and HTMX swaps
    function initSparklinesAndStats() {
        if (window.statsInterval) clearInterval(window.statsInterval);

        refreshStats();
        window.statsInterval = setInterval(refreshStats, 30000); // Every 30 seconds

        // Initialize Sparklines
        document.querySelectorAll('canvas[data-sparkline]').forEach(canvas => {
            const data = JSON.parse(canvas.getAttribute('data-sparkline'));
            if (typeof MiniChart !== 'undefined') {
                MiniChart.renderLine(canvas.id, data);
            }
        });

        // Set maintenance toggle state
        fetch('/admin/maintenance').then(r => r.json()).then(d => {
            const toggle = document.getElementById('maintenance-toggle');
            if (toggle) toggle.checked = d.maintenance_mode;
        }).catch(() => { });
    }

    document.addEventListener('DOMContentLoaded', initSparklinesAndStats);
    document.addEventListener('htmx:load', initSparklinesAndStats);
</script>
{% endblock %}