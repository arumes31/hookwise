{% extends 'base.html' %}

{% block content %}
<div class="row g-4 mb-5">
    <!-- Stat Cards -->
    <div class="col-md-3">
        <div class="card bg-dark border-0 shadow-sm accent-border-top">
            <div class="card-body text-center p-4">
                <h6 class="text-secondary text-uppercase small ls-wide mb-2">Created Today</h6>
                <h2 class="fw-bold mb-0 text-white" id="stat-created">0</h2>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-dark border-0 shadow-sm accent-border-top" style="--accent: #10b981;">
            <div class="card-body text-center p-4">
                <h6 class="text-secondary text-uppercase small ls-wide mb-2">Closed Today</h6>
                <h2 class="fw-bold mb-0 text-white" id="stat-closed">0</h2>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-dark border-0 shadow-sm accent-border-top" style="--accent: #f59e0b;">
            <div class="card-body text-center p-4">
                <h6 class="text-secondary text-uppercase small ls-wide mb-2">Success Rate</h6>
                <h2 class="fw-bold mb-0 text-white"><span id="stat-rate">100</span>%</h2>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-dark border-0 shadow-sm accent-border-top" style="--accent: #ef4444;">
            <div class="card-body text-center p-4">
                <h6 class="text-secondary text-uppercase small ls-wide mb-2">Failed Attempts</h6>
                <h2 class="fw-bold mb-0 text-white" id="stat-failed">0</h2>
            </div>
        </div>
    </div>
</div>

<div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="accent-gradient fw-bold mb-0">Webhook Endpoints</h1>
    <div class="d-flex gap-2">
        <div class="input-group input-group-sm" style="width: 250px;">
            <span class="input-group-text bg-dark border-secondary text-secondary">
                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" class="bi bi-search"
                    viewBox="0 0 16 16">
                    <path
                        d="M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001c.03.04.062.078.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1.007 1.007 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0z" />
                </svg>
            </span>
            <input type="text" id="endpoint-search" class="form-control bg-dark border-secondary text-white"
                placeholder="Search endpoints...">
        </div>
        <a href="{{ url_for('main.new_endpoint') }}" class="btn btn-primary d-flex align-items-center">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                class="bi bi-plus-lg me-2" viewBox="0 0 16 16">
                <path fill-rule="evenodd"
                    d="M8 2a.5.5 0 0 1 .5.5v5h5a.5.5 0 0 1 0 1h-5v5a.5.5 0 0 1-1 0v-5h-5a.5.5 0 0 1 0-1h5v-5A.5.5 0 0 1 8 2Z" />
            </svg>
            Create New
        </a>
    </div>
</div>

<div id="bulk-controls"
    class="alert alert-dark border-secondary d-none mb-4 d-flex justify-content-between align-items-center py-2">
    <span class="small text-secondary fw-bold">SELECTED ACTIONS</span>
    <div class="d-flex gap-2">
        <button class="btn btn-sm btn-outline-danger" onclick="bulkDelete()">Delete Selected</button>
        <button class="btn btn-sm btn-outline-secondary" onclick="bulkPause()">Pause Selected</button>
    </div>
</div>

{% if not configs %}
<div class="text-center py-5">
    <img src="{{ url_for('static', filename='img/logo.png') }}" alt="Empty" class="opacity-75 mb-4"
        style="filter: grayscale(0.5); height: 120px;">
    <h3 class="text-secondary">No Endpoints Yet</h3>
    <p class="text-muted">Get started by creating your first webhook routing endpoint.</p>
    <a href="{{ url_for('main.new_endpoint') }}" class="btn btn-outline-primary mt-3">Create First Endpoint</a>
</div>
{% else %}
<div class="row mb-5">
    <div class="col-12">
        <div class="card bg-dark text-white shadow-lg overflow-hidden">
            <div
                class="card-header border-bottom border-light border-opacity-10 d-flex justify-content-between align-items-center">
                <div class="d-flex align-items-center">
                    <span class="h6 mb-0 fw-bold me-3">Live Activity Log</span>
                    <div id="log-legend" class="d-flex gap-2 small">
                        <span
                            class="badge bg-success bg-opacity-10 text-success border border-success border-opacity-25">UP</span>
                        <span
                            class="badge bg-warning bg-opacity-10 text-warning border border-warning border-opacity-25">DOWN</span>
                        <span
                            class="badge bg-info bg-opacity-10 text-info border border-info border-opacity-25">SYSTEM</span>
                    </div>
                </div>
                <div class="d-flex gap-2 align-items-center">
                    <input type="text" id="log-filter"
                        class="form-control form-control-sm bg-black bg-opacity-50 border-secondary text-white"
                        placeholder="Filter logs..." style="width: 150px;">
                    <button id="pause-button" class="btn btn-sm btn-outline-secondary"
                        data-tooltip="Pause/Resume Log Feed">
                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor"
                            class="bi bi-pause-fill" viewBox="0 0 16 16">
                            <path
                                d="M5.5 3.5A1.5 1.5 0 0 1 7 5v6a1.5 1.5 0 0 1-3 0V5a1.5 1.5 0 0 1 1.5-1.5zm5 0A1.5 1.5 0 0 1 12 5v6a1.5 1.5 0 0 1-3 0V5a1.5 1.5 0 0 1 1.5-1.5z" />
                        </svg>
                    </button>
                    <button id="time-toggle" class="btn btn-sm btn-outline-secondary" data-tooltip="Toggle Time Format">
                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor"
                            class="bi bi-clock" viewBox="0 0 16 16">
                            <path
                                d="M8 3.5a.5.5 0 0 0-1 0V9a.5.5 0 0 0 .252.434l3.5 2a.5.5 0 0 0 .496-.868L8 8.71V3.5z" />
                            <path d="M8 16A8 8 0 1 0 8 0a8 8 0 0 0 0 16zm7-8A7 7 0 1 1 1 8a7 7 0 0 1 14 0z" />
                        </svg>
                    </button>
                    <span id="socket-status" class="badge bg-secondary">Connecting...</span>
                </div>
            </div>
            <div class="card-body p-0">
                <div id="log-container" class="p-3"
                    style="height: 350px; overflow-y: auto; font-family: 'JetBrains Mono', 'Fira Code', monospace; font-size: 0.8rem; background: #0d1117;">
                    <div class="text-muted opacity-50 italic">Waiting for activity...</div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="mb-3 d-flex justify-content-between align-items-center">
    <div class="form-check">
        <input class="form-check-input" type="checkbox" id="check-all">
        <label class="form-check-label small text-secondary fw-bold" for="check-all">SELECT ALL</label>
    </div>
    <div class="btn-group btn-group-sm">
        <button class="btn btn-outline-secondary active" onclick="toggleView('grid')">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-grid-fill"
                viewBox="0 0 16 16">
                <path
                    d="M1 2.5A1.5 1.5 0 0 1 2.5 1h3A1.5 1.5 0 0 1 7 2.5v3A1.5 1.5 0 0 1 5.5 7h-3A1.5 1.5 0 0 1 1 5.5v-3zM9 2.5A1.5 1.5 0 0 1 10.5 1h3A1.5 1.5 0 0 1 15 2.5v3A1.5 1.5 0 0 1 13.5 7h-3A1.5 1.5 0 0 1 9 5.5v-3zM1 10.5A1.5 1.5 0 0 1 2.5 9h3A1.5 1.5 0 0 1 7 10.5v3A1.5 1.5 0 0 1 5.5 15h-3A1.5 1.5 0 0 1 1 13.5v-3zM9 10.5A1.5 1.5 0 0 1 10.5 9h3a1.5 1.5 0 0 1 1.5 1.5v3a1.5 1.5 0 0 1-1.5 1.5h-3A1.5 1.5 0 0 1 9 13.5v-3z" />
            </svg>
        </button>
        <button class="btn btn-outline-secondary" onclick="toggleView('list')">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-list-task"
                viewBox="0 0 16 16">
                <path fill-rule="evenodd"
                    d="M2 2.5a.5.5 0 0 0-.5.5v1a.5.5 0 0 0 .5.5h1a.5.5 0 0 0 .5-.5V3a.5.5 0 0 0-.5-.5H2zM3 12a1 1 0 1 0 0-2 1 1 0 0 0 0 2zm0-3a1 1 0 1 0 0-2 1 1 0 0 0 0 2zm0-3a1 1 0 1 0 0-2 1 1 0 0 0 0 2zm9 7a1 1 0 1 0 0-2 1 1 0 0 0 0 2zm0-3a1 1 0 1 0 0-2 1 1 0 0 0 0 2zm0-3a1 1 0 1 0 0-2 1 1 0 0 0 0 2zM9.172 3.03a.5.5 0 0 1 .664-.058l.1.058l2 2a.5.5 0 1 1-.708.707L10 4.414V11a.5.5 0 0 1-1 0V4.414L7.854 5.51a.5.5 0 0 1-.708-.707l2-2z" />
            </svg>
        </button>
    </div>
</div>

<div class="row" id="endpoint-grid">
    {% for config in configs %}
    <div class="col-md-6 mb-4">
        <div class="card h-100 border-1 endpoint-card" data-name="{{ config.name }}" data-id="{{ config.id }}">
            <div class="card-body p-4">
                <div class="d-flex justify-content-between align-items-start mb-3">
                    <div class="d-flex align-items-start">
                        <input type="checkbox" class="endpoint-check form-check-input me-3 mt-1"
                            data-id="{{ config.id }}">
                        <div>
                            <h5 class="card-title mb-1 text-white fw-bold">{{ config.name }}</h5>
                            <div class="d-flex gap-2 align-items-center">
                                <small class="text-secondary font-monospace" style="font-size: 0.7rem;">ID: {{
                                    config.id[:8] }}...</small>
                                <span class="badge bg-dark text-secondary border border-secondary border-opacity-25"
                                    style="font-size: 0.6rem;">
                                    LAST SEEN: {{ config.last_seen_at.strftime('%m/%d %H:%M') if config.last_seen_at
                                    else 'NEVER' }}
                                </span>
                            </div>
                        </div>
                    </div>
                    <div class="d-flex gap-2">
                        <button onclick="testEndpoint('{{ config.id }}')"
                            class="btn btn-link p-0 text-secondary hover-info" data-tooltip="Test Endpoint">
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor"
                                class="bi bi-play-circle" viewBox="0 0 16 16">
                                <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z" />
                                <path
                                    d="M6.271 5.055a.5.5 0 0 1 .52.038l3.5 2.5a.5.5 0 0 1 0 .814l-3.5 2.5A.5.5 0 0 1 6 10.5v-5a.5.5 0 0 1 .271-.445z" />
                            </svg>
                        </button>
                        <a href="{{ url_for('main.edit_endpoint', id=config.id) }}"
                            class="btn btn-link p-0 text-secondary hover-primary" data-tooltip="Edit Endpoint">
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor"
                                class="bi bi-pencil-square" viewBox="0 0 16 16">
                                <path
                                    d="M15.502 1.94a.5.5 0 0 1 0 .706L14.459 3.69l-2-2L13.502.646a.5.5 0 0 1 .707 0l1.293 1.293zm-1.75 2.456-2-2L4.939 9.21a.5.5 0 0 0-.121.196l-.805 2.414a.25.25 0 0 0 .316.316l2.414-.805a.5.5 0 0 0 .196-.12l6.813-6.814z" />
                                <path fill-rule="evenodd"
                                    d="M1 13.5A1.5 1.5 0 0 0 2.5 15h11a1.5 1.5 0 0 0 1.5-1.5v-6a.5.5 0 0 0-1 0v6a.5.5 0 0 1-.5.5h-11a.5.5 0 0 1-.5-.5v-11a.5.5 0 0 1 .5-.5H9a.5.5 0 0 0 0-1H2.5A1.5 1.5 0 0 0 1 2.5v11z" />
                            </svg>
                        </a>
                        <form action="{{ url_for('main.delete_endpoint', id=config.id) }}" method="POST"
                            onsubmit="return confirm('Delete this endpoint?');">
                            <button type="submit" class="btn btn-link p-0 text-secondary hover-danger"
                                data-tooltip="Delete Endpoint">
                                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor"
                                    class="bi bi-trash3" viewBox="0 0 16 16">
                                    <path
                                        d="M6.5 1h3a.5.5 0 0 1 .5.5v1H6v-1a.5.5 0 0 1 .5-.5ZM11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3A1.5 1.5 0 0 0 5 1.5v1H2.506a.58.58 0 0 0-.01 0H1.5a.5.5 0 0 0 0 1h.538l.853 10.66A2 2 0 0 0 4.885 16h6.23a2 2 0 0 0 1.994-1.84l.853-10.66h.538a.5.5 0 0 0 0-1h-.995a.59.59 0 0 0-.01 0H11Zm1.958 1-.846 10.58a1 1 0 0 1-.997.92h-6.23a1 1 0 0 1-.997-.92L3.042 3.5h9.916Zm-7.487 1a.5.5 0 0 1 .528.47l.5 8.5a.5.5 0 0 1-.998.06L5 5a.5.5 0 0 1 .47-.53Zm3.303 0a.5.5 0 0 1 .47.53L8.5 14.03a.5.5 0 0 1-.998-.06l.5-8.5a.5.5 0 0 1 .528-.47ZM8 4.5a.5.5 0 0 1 .5.5v8.5a.5.5 0 0 1-1 0V5a.5.5 0 0 1 .5-.5Z" />
                                </svg>
                            </button>
                        </form>
                    </div>

                    <div class="mb-4">
                        <label class="text-secondary small fw-bold mb-1 d-block"
                            style="letter-spacing: 0.05em; font-size: 0.65rem;">ENDPOINT URL</label>
                        <div
                            class="d-flex align-items-center bg-black bg-opacity-40 rounded p-2 border border-secondary border-opacity-10 shadow-inner">
                            <code class="user-select-all text-truncate flex-grow-1 border-0 bg-transparent"
                                style="font-size: 0.75rem;">{{ base_url }}/w/{{ config.id }}</code>
                            <button class="btn btn-sm btn-link text-primary p-0 ms-2"
                                onclick="copyToClipboard('{{ base_url }}/w/{{ config.id }}')"
                                data-tooltip="Copy to Clipboard">
                                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor"
                                    class="bi bi-clipboard" viewBox="0 0 16 16">
                                    <path
                                        d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1h1a1 1 0 0 1 1 1V14a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V3.5a1 1 0 0 1 1-1h1v-1z" />
                                    <path
                                        d="M9.5 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3zm-3-1A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3z" />
                                </svg>
                            </button>
                        </div>
                    </div>

                    <div class="row g-2 mt-auto">
                        <div class="col-6">
                            <div class="config-item shadow-sm">
                                <small class="text-secondary d-block small fw-bold"
                                    style="font-size: 0.6rem;">PREFIX</small>
                                <span class="small">{{ config.ticket_prefix or 'Default' }}</span>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="config-item shadow-sm">
                                <small class="text-secondary d-block small fw-bold"
                                    style="font-size: 0.6rem;">BOARD</small>
                                <span class="small">{{ config.board or 'Default' }}</span>
                            </div>
                        </div>
                        <div class="col-12">
                            <div class="config-item shadow-sm">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <small class="text-secondary d-block small fw-bold"
                                            style="font-size: 0.6rem;">TRIGGER FIELD</small>
                                        <span class="small font-monospace text-primary" style="font-size: 0.7rem;">{{
                                            config.trigger_field }}</span>
                                    </div>
                                    <div class="text-end">
                                        <small class="text-secondary d-block small fw-bold"
                                            style="font-size: 0.6rem;">VALUES (OPEN | CLOSE)</small>
                                        <span class="badge badge-outline border-danger text-danger"
                                            style="font-size: 0.7rem;">{{ config.open_value }}</span>
                                        <span class="badge badge-outline border-success text-success"
                                            style="font-size: 0.7rem;">{{ config.close_value }}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    {% endif %}

    <!-- Payload Modal -->
    <div class="modal fade" id="payloadModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content bg-dark border-secondary">
                <div class="modal-header border-secondary">
                    <h5 class="modal-title">Webhook Payload</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <pre id="payload-display" class="bg-black p-3 rounded text-info"
                        style="font-size: 0.85rem; max-height: 500px; overflow: auto;"></pre>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Live Dashboard Logic (Refined)
        let isPaused = false;
        let absoluteTime = false;

        document.addEventListener('DOMContentLoaded', function () {
            const socket = io({ reconnection: true });
            const logContainer = document.getElementById('log-container');
            if (!logContainer) return; // Exit if activity log is not present

            const statusBadge = document.getElementById('socket-status');
            const pauseBtn = document.getElementById('pause-button');
            const timeBtn = document.getElementById('time-toggle');
            const logFilter = document.getElementById('log-filter');

            if (pauseBtn) {
                pauseBtn.addEventListener('click', () => {
                    isPaused = !isPaused;
                    pauseBtn.classList.toggle('btn-primary', isPaused);
                    pauseBtn.classList.toggle('btn-outline-secondary', !isPaused);
                });
            }

            if (timeBtn) {
                timeBtn.addEventListener('click', () => {
                    absoluteTime = !absoluteTime;
                    timeBtn.classList.toggle('btn-primary', absoluteTime);
                    timeBtn.classList.toggle('btn-outline-secondary', !absoluteTime);
                    // Refresh visible logs to update time format
                    logContainer.querySelectorAll('.log-entry').forEach(entry => {
                        const ts = entry.dataset.timestamp;
                        if (ts) {
                            const timeSpan = entry.querySelector('.text-secondary');
                            if (timeSpan) {
                                const date = new Date(ts);
                                timeSpan.textContent = absoluteTime ? `[${date.toLocaleTimeString()}]` : `[${getRelativeTime(date)}]`;
                            }
                        }
                    });
                });
            }

            socket.on('connect', () => {
                statusBadge.textContent = 'Live';
                statusBadge.className = 'badge bg-success';
            });

            socket.on('new_log', (data) => {
                if (isPaused) return;

                if (logContainer.querySelector('.text-muted')) {
                    logContainer.innerHTML = '';
                }

                const logEntry = document.createElement('div');
                logEntry.className = `log-entry mb-1 py-1 border-bottom border-light border-opacity-5 text-${data.level === 'warning' ? 'warning' : data.level === 'success' ? 'success' : 'info'}`;

                // Time logic
                const logDate = new Date(data.timestamp);
                const absoluteTimeStr = logDate.toLocaleTimeString();
                const displayTime = absoluteTime ? `[${absoluteTimeStr}]` : `[${getRelativeTime(logDate)}]`;

                // Troubleshooting link
                const helpLink = getTroubleshootingLink(data.message.toLowerCase());

                // Ticket Link logic
                let ticketHtml = '';
                if (data.ticket_id) {
                    ticketHtml = `
                    <span class="ms-2">
                        <a href="https://api-na.myconnectwise.net/v4_6_release/apis/3.0/service/tickets/${data.ticket_id}" target="_blank" class="badge bg-primary bg-opacity-25 text-primary text-decoration-none border border-primary border-opacity-25" style="font-size: 0.65rem;">
                            TICKET #${data.ticket_id}
                        </a>
                    </span>
                `;
                }

                logEntry.dataset.timestamp = data.timestamp;
                logEntry.innerHTML = `
                <span class="text-secondary me-2">${displayTime}</span>
                <span class="fw-bold me-2">${data.config_name}:</span>
                <span style="cursor: ${data.payload ? 'pointer' : 'default'}">${data.message}</span>
                ${ticketHtml}
                ${helpLink ? `<a href="${helpLink}" target="_blank" class="ms-2 small text-secondary" title="Troubleshoot this error"><svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" fill="currentColor" class="bi bi-question-circle" viewBox="0 0 16 16"><path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/><path d="M5.255 5.786a.237.237 0 0 0 .241.247h.825c.138 0 .248-.113.266-.25.09-.656.54-1.134 1.342-1.134.686 0 1.314.343 1.314 1.168 0 .635-.374.927-.965 1.371-.673.489-1.206 1.06-1.168 1.987l.003.217a.25.25 0 0 0 .25.246h.811a.25.25 0 0 0 .25-.25v-.105c0-.718.273-.927 1.01-1.486.609-.463 1.244-.977 1.244-2.056 0-1.511-1.276-2.241-2.673-2.241-1.267 0-2.655.59-2.75 2.286zm1.557 5.763c0 .533.425.927 1.01.927.609 0 1.028-.394 1.028-.94 0-.552-.42-.94-1.029-.94-.584 0-1.009.388-1.009.94z"/></svg></a>` : ''}
                ${data.payload ? '<span class="float-end opacity-50 clickable-payload"><svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" fill="currentColor" class="bi bi-code" viewBox="0 0 16 16"><path d="M5.854 4.854a.5.5 0 1 0-.708-.708l-3.5 3.5a.5.5 0 0 0 0 .708l3.5 3.5a.5.5 0 0 0 .708-.708L2.707 8l3.147-3.146zm4.292 0a.5.5 0 0 1 .708-.708l3.5 3.5a.5.5 0 0 1 0 .708l-3.5 3.5a.5.5 0 0 1-.708-.708L13.293 8l-3.147 3.146z"/></svg></span>' : ''}
            `;

                if (data.payload) {
                    logEntry.addEventListener('click', (e) => {
                        // Prevent modal from opening if a link (ticket or help) was clicked
                        if (e.target.tagName !== 'A' && e.target.closest('A') === null) {
                            document.getElementById('payload-display').textContent = JSON.stringify(data.payload, null, 2);
                            new bootstrap.Modal(document.getElementById('payloadModal')).show();
                        }
                    });
                }

                logContainer.appendChild(logEntry);
                logContainer.scrollTop = logContainer.scrollHeight;

                while (logContainer.childNodes.length > 200) {
                    logContainer.removeChild(logContainer.firstChild);
                }
            });

            // Log Filter Logic
            if (logFilter) {
                logFilter.addEventListener('input', (e) => {
                    const term = e.target.value.toLowerCase();
                    logContainer.querySelectorAll('.log-entry').forEach(entry => {
                        entry.style.display = entry.innerText.toLowerCase().includes(term) ? 'block' : 'none';
                    });
                });
            }
        });

        function copyToClipboard(text) {
            navigator.clipboard.writeText(text);
            showToast('URL copied to clipboard!', 'success');
        }

        function testEndpoint(id) {
            fetch(`/endpoint/test/${id}`, { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        showToast('Test webhook queued!', 'success');
                    } else {
                        showToast('Error: ' + data.message, 'danger');
                    }
                })
                .catch(error => {
                    showToast('Connection error', 'danger');
                });
        }

        function toggleView(view) {
            const grid = document.getElementById('endpoint-grid');
            if (view === 'list') {
                grid.querySelectorAll('.col-md-6').forEach(col => {
                    col.classList.remove('col-md-6');
                    col.classList.add('col-12');
                });
            } else {
                grid.querySelectorAll('.col-12').forEach(col => {
                    col.classList.remove('col-12');
                    col.classList.add('col-md-6');
                });
            }
        }

        function refreshStats() {
            fetch('/api/stats')
                .then(res => res.json())
                .then(data => {
                    document.getElementById('stat-created').textContent = data.created_today;
                    document.getElementById('stat-closed').textContent = data.closed_today;
                    document.getElementById('stat-rate').textContent = data.success_rate;
                    document.getElementById('stat-failed').textContent = data.failed_today;
                })
                .catch(err => console.error('Error fetching stats:', err));
        }

        // Initial load and periodic refresh
        document.addEventListener('DOMContentLoaded', () => {
            refreshStats();
            setInterval(refreshStats, 30000); // Every 30 seconds
        });
    </script>
    {% endblock %}